var e=Object.defineProperty,t=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s);import{I as i,J as s,K as r,M as a,N as n,p as o,O as c,Q as h,R as l,l as d,r as p,u as m,U as u,_ as f,X as g,Y as v,x as I,Z as b,$ as y,d as S,a0 as _,a1 as E,H as R,a2 as k,a3 as C,j as T,a4 as w,a5 as O,v as M,a6 as x,a7 as P,a8 as L,a9 as A,aa as D,ab as H,ac as $,ad as G,ae as z,w as B,C as N,t as j,V as F,af as q,n as V,ag as W,B as K}from"./index.5c4cb14.js";import{f as Q,h as U,i as Y,j as X,k as J,l as Z,m as ee,n as te,Z as ie,o as se,q as re,r as ae,s as ne,t as oe,u as ce}from"./options.5c4cb14.js";import{P as he,a as le}from"./PaneHeader.5c4cb14.js";import{I as de}from"./IndicatorDropdown.5c4cb14.js";import{A as pe}from"./AlertsList.5c4cb14.js";const me=new class extends i{constructor(){super(),t(this,"url"),t(this,"promisesOfData",{}),this.url=s("historical")}filterOutUnavailableMarkets(e){return e.filter(e=>-1!==r.state.app.historicalMarkets.indexOf(e))}getApiUrl(e,t,i,s){const r=[e,t,(1e3*i).toString()];return s&&s.length&&r.push(encodeURIComponent(s.join("+"))),`${this.url}/${r.join("/")}`}fetch(e,t,i,s){const n=this.getApiUrl(e,t,i,s);return this.promisesOfData[n]||(this.promisesOfData[n]=fetch(n).then(async e=>{const t=e.headers.get("content-type");let i;if(!t||-1===t.indexOf("application/json"))throw new Error(await e.text());return i=await e.json(),i.status=e.status,i}).then(e=>{if(!e||e.error)throw new Error(e&&e.error?e.error:"empty-response");if("point"!==e.format)throw new Error("Bad data");if(!e.results.length)throw new Error("No more data");return this.normalizePoints(e.results,e.columns,i,s)}).catch(e=>{throw a(e),e}).then(e=>(r.commit("app/TOGGLE_LOADING",!1),delete this.promisesOfData[n],e))),this.promisesOfData[n]}normalizePoints(e,t,i,s){const a={},h={};if(s=s.slice(),!e||!e.length)return e;let l;l=Array.isArray(e[0])?e[0][0]:+new Date(e[0].time)/1e3,s=[...s];const d=c(i),p=r.state.settings.preferQuoteCurrencySize;for(let r=0;r<e.length;r++){if(!e[r].time&&e[r][0])e[r]={time:void 0!==t.time?e[r][t.time]:0,cbuy:void 0!==t.cbuy?e[r][t.cbuy]:0,close:void 0!==t.close?e[r][t.close]:0,csell:void 0!==t.csell?e[r][t.csell]:0,high:void 0!==t.high?e[r][t.high]:0,lbuy:void 0!==t.lbuy?e[r][t.lbuy]:0,low:void 0!==t.low?e[r][t.low]:0,lsell:void 0!==t.lsell?e[r][t.lsell]:0,market:void 0!==t.market?e[r][t.market]:0,open:void 0!==t.open?e[r][t.open]:0,vbuy:void 0!==t.vbuy?e[r][t.vbuy]:0,vsell:void 0!==t.vsell?e[r][t.vsell]:0};else{if(!a[e[r].market])for(let t=r-1;t>=0;t--)if(e[t].market===e[r].market){a[e[r].market]=e[t];break}if(e[r].time=n(e[r].time/1e3,i,d),!p&&(e[r].vbuy||e[r].vsell)&&e[r].close&&(e[r].vbuy=e[r].vbuy/e[r].close,e[r].vsell=e[r].vsell/e[r].close),!a[e[r].market]||a[e[r].market].time<e[r].time)a[e[r].market]=e[r];else if(a[e[r].market]!==e[r]){a[e[r].market].vbuy+=e[r].vbuy,a[e[r].market].vsell+=e[r].vsell,a[e[r].market].cbuy+=e[r].cbuy,a[e[r].market].csell+=e[r].csell,a[e[r].market].lbuy+=e[r].lbuy,a[e[r].market].lsell+=e[r].lsell,a[e[r].market].high=Math.max(e[r].high,a[e[r].market].high),a[e[r].market].low=Math.min(e[r].low,a[e[r].market].low),a[e[r].market].close=e[r].close,e.splice(r,1),r--;continue}}if(h[e[r].market]||(h[e[r].market]=e[r].close),!p&&(e[r].vbuy||e[r].vsell)&&e[r].close&&(e[r].vbuy=e[r].vbuy/e[r].close,e[r].vsell=e[r].vsell/e[r].close),e[r].time===l){const t=s.indexOf(e[r].market);s.splice(t,1)}const[c,m]=o(e[r].market);e[r].exchange=c,e[r].pair=m}return{data:e,markets:s,from:e[0].time,to:e[e.length-1].time,initialPrices:h}}};class ue{constructor(){t(this,"chunks",[]),t(this,"cacheRange",{from:null,to:null})}saveChunk(e){let t;if(!this.chunks.length||this.chunks[this.chunks.length-1].to<e.from)t=this.chunks.push(e)-1;else{if(!(this.chunks[0].from>e.to))return this.chunks[0];this.chunks.unshift(e),t=0}return 0===t&&(this.cacheRange.from=e.from),t===this.chunks.length-1&&(this.cacheRange.to=e.to),e}clear(){this.chunks.splice(0,this.chunks.length),this.cacheRange.from=this.cacheRange.to=null}trim(e){if(!this.chunks.length)return;let t=!1;for(;this.chunks[0]&&this.chunks[0].to<e;)this.chunks.splice(0,1),t=!0;return this.cacheRange.from=this.chunks[0].from,t}}class fe{constructor(e,i){t(this,"isBusy",!1),t(this,"api"),t(this,"alert"),t(this,"priceline"),t(this,"timestamp"),t(this,"chart"),t(this,"offset"),t(this,"originalOffset"),t(this,"referencePrice"),t(this,"moved"),t(this,"levelDragMoveHandler"),t(this,"levelDragEndHandler"),this.chart=e,!this.chart.isLoading&&this.initialize(i)&&this.bindEvents(i)}initialize(e){if(this.api=this.chart.getPriceApi(),!this.api)return!1;this.offset=h(e),this.originalOffset={...this.offset};const t=this.api.coordinateToPrice(this.offset.y);if(!t)return!1;this.priceline=this.api.getPriceLine(t,this.chart.chartInstance.timeScale().coordinateToLogical(this.offset.x));const i=r.state.settings.alertsClick||e.altKey;return!(!this.priceline&&!i)&&(this.referencePrice=this.chart.getPrice(),this.timestamp=Date.now(),this.alert=this.getAlert(t),!0)}getMoveEvent(e){return/touch/.test(e.type)?"touchmove":"mousemove"}getEndEvent(e){return/touch/.test(e.type)?"touchend":"mouseup"}bindEvents(e){const t=this.chart.getChartCanvas();this.levelDragMoveHandler=this.onLevelDragMove.bind(this),this.levelDragEndHandler=this.onLevelDragEnd.bind(this),t.addEventListener(this.getMoveEvent(e),this.levelDragMoveHandler),t.addEventListener(this.getEndEvent(e),this.levelDragEndHandler)}getAlert(e){let t;if(this.priceline){const i=this.priceline.options();t=i.market,i.market?(t=i.market,e=i.price):this.priceline=null}return t||(t=this.chart.mainIndex),{price:e,market:t}}onLevelDragMove(e){const{x:t,y:i}=h(e),s=Math.abs(this.originalOffset.y-i)>5||Date.now()-this.timestamp>750;if(this.offset.x=t,this.offset.y=i,this.priceline){if(e.stopPropagation(),!s)return;const t=l.formatPrice(this.api.coordinateToPrice(i));let a;if(!this.moved){const e=d(r.state.settings.alertsColor);a=p([e[0],e[1],e[2],.5*(e[3]||1)])}this.priceline.applyOptions({price:t,color:a}),this.moved=!0}else s&&this.unbindEvents(e)}async onLevelDragEnd(e){const t=Math.abs(this.originalOffset.y-this.offset.y)>5||Date.now()-this.timestamp>750,i=!this.priceline&&!t&&Math.abs(this.originalOffset.x-this.offset.x)+Math.abs(this.originalOffset.y-this.offset.y)<10;r.state.settings.alerts&&(e.altKey||r.state.settings.alertsClick);const s=this.alert.market;if((this.priceline||i)&&this.chart.chartInstance.clearCrosshairPosition(),this.unbindEvents(e),!this.chart.isLoading)try{if(this.isBusy=!0,this.priceline){const e=l.alerts[this.alert.market].find(e=>e.price===this.alert.price),{price:i,title:r}=this.priceline.options(),a={active:!1,price:i,market:s,message:r};this.alert.price!==i&&t?(e&&await l.moveAlert(e.market,e.price,a,this.referencePrice),this.api.removePriceLine(this.priceline)):await l.removeAlert(this.alert)}else if(i){const e=this.chart.chartInstance.timeScale().coordinateToTime(this.offset.x),t={price:this.alert.price,market:this.alert.market,timestamp:e,active:!1};await l.createAlert(t,this.chart.getPrice())}}finally{this.isBusy=!1}}unbindEvents(e){const t=this.chart.getChartCanvas();t.removeEventListener(this.getEndEvent(e),this.levelDragEndHandler),this.levelDragEndHandler=null,t.removeEventListener(this.getMoveEvent(e),this.levelDragMoveHandler),this.levelDragMoveHandler=null}}class ge{constructor(e,i){t(this,"isBusy",!1),t(this,"api"),t(this,"chart"),t(this,"a"),t(this,"b"),t(this,"market"),t(this,"measurementComponent"),t(this,"isLoading"),t(this,"canvas"),t(this,"height"),t(this,"top"),t(this,"left"),t(this,"width"),t(this,"onMoveHandler"),t(this,"onEndHandler"),t(this,"onPanHandler"),this.chart=e,this.canvas=this.chart.getChartCanvas(),this.initialize(i)&&this.bindEvents(i)}initialize(e){var t;if(this.api=this.chart.getPriceApi(),!this.api)return!1;const{x:i,y:s}=m(e,!0),{top:r,left:a}=this.canvas.getBoundingClientRect();return this.top=r,this.height=this.canvas.height,this.left=a,this.width=this.canvas.width,this.a={x:Math.max(0,Math.min(this.width,i-a)),y:Math.max(0,Math.min(this.height,s-r))},this.a.price=this.api.coordinateToPrice(this.a.y),this.a.time=null==(t=this.chart.chartInstance.timeScale())?void 0:t.coordinateToTime(this.a.x),!!this.a.price&&(this.market=this.chart.mainIndex,!0)}getMoveEvent(e){return/touch/.test(e.type)?"touchmove":"mousemove"}getEndEvent(e){return/touch/.test(e.type)?"touchend":"mouseup"}getClearEvent(){return/touch/.test(event.type)?"touchstart":"mousedown"}bindEvents(e){this.chart.chartInstance.applyOptions({handleScroll:!1}),this.onMoveHandler=this.onMove.bind(this),this.onEndHandler=this.onEnd.bind(this),document.body.addEventListener(this.getMoveEvent(e),this.onMoveHandler),document.body.addEventListener(this.getEndEvent(e),this.onEndHandler)}onPan(){const e=this.chart.getPriceApi(),t=this.chart.chartInstance.timeScale();t&&(this.a.x=t.timeToCoordinate(this.a.time),this.b.x=t.timeToCoordinate(this.b.time)),this.a.y=e.priceToCoordinate(this.a.price),this.b.y=e.priceToCoordinate(this.b.price),this.updateComponent()}onMove(e){var t;const{x:i,y:s}=m(e,!0);this.b={x:Math.max(0,Math.min(this.width,i-this.left)),y:Math.max(0,Math.min(this.height,s-this.top))},this.b.price=this.api.coordinateToPrice(this.b.y),this.b.time=null==(t=this.chart.chartInstance.timeScale())?void 0:t.coordinateToTime(this.b.x),this.measurementComponent?this.updateComponent():this.createComponent()}getPropsData(){const e=[this.a.x,this.b.x].sort((e,t)=>e-t),t=[this.a.y,this.b.y].sort((e,t)=>e-t),i=[this.a.price,this.b.price].sort((e,t)=>e-t),s=(this.b.price-this.a.price)/Math.abs(this.a.price)*100;return{position:{top:t[0],left:e[0],width:e[1]-e[0],height:t[1]-t[0]},low:+u(i[0],this.market),high:+u(i[1],this.market),percent:s}}async createComponent(){if(this.isBusy=!0,this.isLoading)return!1;this.isLoading=!0,document.body.style.cursor="progress";const e=await f(()=>import("./ChartMeasurement.5c4cb14.js"),["ChartMeasurement.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","ChartMeasurement.5c4cb14.css"]),{position:t,low:i,high:s,percent:r}=this.getPropsData();this.measurementComponent=g(e.default,{position:t,low:i,high:s,percent:r}),v(this.measurementComponent,this.canvas.parentElement);const a=this.chart.chartInstance.timeScale();a&&(this.onPanHandler=this.onPan.bind(this),a.subscribeVisibleLogicalRangeChange(this.onPanHandler)),this.isLoading=!1,document.body.style.cursor=""}updateComponent(){const{position:e,low:t,high:i,percent:s}=this.getPropsData();this.measurementComponent.position=e,this.measurementComponent.low=t,this.measurementComponent.high=i,this.measurementComponent.percent=s}onEnd(e){this.unbindEvents(e)}async unbindEvents(e){document.body.removeEventListener(this.getEndEvent(e),this.onEndHandler),this.onEndHandler=null,document.body.removeEventListener(this.getMoveEvent(e),this.onMoveHandler),this.onMoveHandler=null,this.chart.chartInstance.applyOptions({handleScroll:!0}),this.canvas.addEventListener(this.getClearEvent(),()=>{this.destroy()},{once:!0})}removeComponent(){if(this.measurementComponent.$destroy(),this.measurementComponent.$el.parentNode.removeChild(this.measurementComponent.$el),this.measurementComponent=null,this.onPanHandler){const e=this.chart.chartInstance.timeScale();e&&e.unsubscribeVisibleLogicalRangeChange(this.onPanHandler),this.onPanHandler=null}}destroy(){this.measurementComponent&&this.removeComponent(),this.isBusy=!1}}class ve{constructor(e){t(this,"chart"),t(this,"onPanTimeout"),t(this,"legendElements"),t(this,"lastCrosshairX"),t(this,"activeEvent"),t(this,"isSyncingCrosshairs"),t(this,"clickHandler"),t(this,"contextMenuHandler"),t(this,"clearChartsCrosshairsHandler"),t(this,"crosshairMoveHandler"),t(this,"onPanHandler"),t(this,"unsubscribeStore"),this.chart=e}bindEvents(){this.subscribeStore(),this.onPanHandler=this.onPan.bind(this),this.chart.chartInstance.timeScale().subscribeVisibleLogicalRangeChange(this.onPanHandler);const e=this.chart.chartElement;this.clickHandler=this.onClick.bind(this),e.addEventListener(I()?"touchstart":"mousedown",this.clickHandler),this.contextMenuHandler=this.onContextMenu.bind(this),e.addEventListener("contextmenu",this.contextMenuHandler),this.crosshairMoveHandler=this.onCrosshairMove.bind(this),this.chart.chartInstance.subscribeCrosshairMove(this.crosshairMoveHandler),this.clearChartsCrosshairsHandler=this.clearChartsCrosshairs.bind(this),e.addEventListener("mouseleave",this.clearChartsCrosshairsHandler),r.state[this.chart.paneId].showIndicators&&r.state[this.chart.paneId].showLegend&&this.bindLegend(),b.push(this.chart)}unbindEvents(){this.unsubscribeStore(),this.unbindLegend(),this.chart.chartInstance.timeScale().unsubscribeVisibleLogicalRangeChange(this.onPan);const e=this.chart.chartElement;{const t=I()?"touchstart":"mousedown";e.removeEventListener(t,this.clickHandler),this.clickHandler=null}e.removeEventListener("contextmenu",this.contextMenuHandler),this.contextMenuHandler=null,this.chart.chartInstance.unsubscribeCrosshairMove(this.crosshairMoveHandler),this.crosshairMoveHandler=null;const t=b.indexOf(this.chart);-1!==t&&b.splice(t,1)}subscribeStore(){this.unsubscribeStore=r.subscribe(e=>{switch(e.type){case this.chart.paneId+"/FLAG_INDICATOR_AS_SAVED":this.chart.saveIndicatorPreview(e.payload);break;case"settings/SET_CHART_THEME":case"settings/SET_TEXT_COLOR":case"settings/SET_BACKGROUND_COLOR":this.chart.chartInstance.applyOptions(X(this.chart.paneId));break;case"settings/TOGGLE_NORMAMIZE_WATERMARKS":this.chart.refreshMarkets();break;case"settings/SET_TIMEZONE_OFFSET":this.chart.setTimezoneOffset(r.state.settings.timezoneOffset),this.chart.clearChart(),this.chart.renderAll();break;case"panes/SET_PANE_MARKETS":e.payload.id===this.chart.paneId&&(r.state[this.chart.paneId].hiddenMarkets={},this.chart.refreshMarkets(),this.chart.clear(),this.chart.fetch());break;case"panes/SET_PANE_ZOOM":e.payload.id===this.chart.paneId&&this.chart.updateFontSize();break;case this.chart.paneId+"/SET_TIMEFRAME":this.chart.clear(),this.chart.fetch();break;case"settings/TOGGLE_ALERTS":case this.chart.paneId+"/TOGGLE_ALERTS":case this.chart.paneId+"/TOGGLE_ALERTS_LABEL":case"settings/SET_ALERTS_COLOR":case"settings/SET_ALERTS_LINESTYLE":case"settings/SET_ALERTS_LINEWIDTH":case"app/EXCHANGE_UPDATED":case this.chart.paneId+"/TOGGLE_MARKET":this.chart.refreshMarkets(),this.chart.refreshAllIndicatorAdapters(),this.chart.renderAll();break;case this.chart.paneId+"/SET_REFRESH_RATE":this.chart.clearQueue(),this.chart.setupQueue();break;case this.chart.paneId+"/TOGGLE_LEGEND":case this.chart.paneId+"/TOGGLE_INDICATORS":r.state[this.chart.paneId].showIndicators&&r.state[this.chart.paneId].showLegend?this.bindLegend():this.unbindLegend();break;case this.chart.paneId+"/SET_GRIDLINES":this.chart.chartInstance.applyOptions(Y(this.chart.paneId));break;case this.chart.paneId+"/SET_BORDER":case this.chart.paneId+"/TOGGLE_AXIS":this.chart.chartInstance.applyOptions(Q(this.chart.paneId)),this.chart.chartInstance.applyOptions(U(this.chart.paneId));break;case this.chart.paneId+"/SET_TEXT_COLOR":this.chart.chartInstance.applyOptions(Q(this.chart.paneId));break;case this.chart.paneId+"/SET_WATERMARK":case this.chart.paneId+"/TOGGLE_NORMAMIZE_WATERMARKS":this.chart.updateWatermark();break;case this.chart.paneId+"/SET_INDICATOR_OPTION":this.chart.setIndicatorOption(e.payload.id,e.payload.key,e.payload.value,e.payload.silent);break;case this.chart.paneId+"/SET_PRICE_SCALE":e.payload.priceScale&&this.chart.refreshPriceScale(e.payload.id);break;case this.chart.paneId+"/SET_INDICATOR_SCRIPT":this.chart.rebuildIndicator(e.payload.id);break;case this.chart.paneId+"/ADD_INDICATOR":this.chart.addIndicator(e.payload.id)&&(this.chart.redrawIndicator(e.payload.id),r.state[this.chart.paneId].showIndicators&&r.state[this.chart.paneId].showLegend&&this.bindLegend(e.payload.id));break;case this.chart.paneId+"/UPDATE_INDICATOR_ORDER":this.chart.moveIndicator(e.payload.id,e.payload.position);break;case this.chart.paneId+"/REMOVE_INDICATOR":this.unbindLegend(e.payload),this.chart.removeIndicator(e.payload);break;case this.chart.paneId+"/TOGGLE_FILL_GAPS_WITH_EMPTY":this.chart.toggleFillGapsWithEmpty();break;case"settings/TOGGLE_AUTO_HIDE_HEADERS":this.chart.refreshChartDimensions()}})}onContextMenu(e){if(window.innerWidth<375)return;const t=e.currentTarget;e.preventDefault();const{x:i,y:s}=m(e,!0),{top:a,left:o}=t.getBoundingClientRect(),c=this.chart.getPriceApi(),h=this.chart.mainIndex;let d,p;if(c){const e=c.coordinateToPrice(s-a);e&&(d=l.formatPrice(e));const t=this.chart.chartInstance.timeScale(),r=c.getPriceLine(d,t?t.coordinateToLogical(i-o):null);if(r){const e=r.options();p={price:e.price,market:e.market,message:e.message}}}const u=n(Date.now()/1e3,this.chart.timeframe),f=r.state[this.chart.paneId].timeframe.toString(),g=this.chart.paneId;this.createContextMenu({value:{top:s-1,left:i-1,width:2,height:2},market:h,price:d,timeframe:f,timestamp:u,paneId:g,alert:p,getPrice:this.chart.getPrice.bind(this.chart)})}async createContextMenu(e){if(y.contextMenu){y.contextMenu.$off("cmd");for(const t in e)y.contextMenu[t]=e[t]}else{document.body.style.cursor="progress";const t=await f(()=>import("./ChartContextMenu.5c4cb14.js"),["ChartContextMenu.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","AlertsList.5c4cb14.js","AlertsList.5c4cb14.css"]);document.body.style.cursor="",y.contextMenu=g(t.default,e),v(y.contextMenu)}y.contextMenu.$on("cmd",e=>{if(!(this.chart[e[0]]instanceof Function))throw new Error(`[chart/control] ContextMenu->chart->${e[0]} is not a function`);this.chart[e[0]](...e.slice(1))})}onClick(e){if(S.hasDialogOpened)return;if(S.hasDialogOpened||e instanceof MouseEvent&&e.button)return;const t=this.activeEvent&&this.activeEvent.isBusy;if(e.shiftKey)this.activeEvent=new ge(this.chart,e);else if(r.state.settings.alerts){if(t)return;this.activeEvent=new fe(this.chart,e)}}onCrosshairMove(e){if(!e||!e.point)return;let t;if(e.point&&e.point.y){const i=this.chart.getPrice(),s=this.chart.getPriceApi();if(i&&s){t=-1*(1-s.coordinateToPrice(e.point.y)/i)}}const i={timestamp:e.time,change:t};_(i,this.chart.paneId),this.isSyncingCrosshairs=!0,E&&E.send("crosshair",i),this.lastCrosshairX!==e.point.x&&(this.lastCrosshairX=e.point.x,this.legendElements&&this.updateLegend(e))}onPan(e){!e||this.chart.panPrevented||this.chart.isLoading||"time"!==this.chart.type||(this.onPanTimeout&&(clearTimeout(this.onPanTimeout),this.onPanTimeout=null),this.onPanTimeout=setTimeout(()=>{this.onPanTimeout=null,null!==this.chart.chartCache.cacheRange.from&&(e=this.chart.chartInstance.timeScale().getVisibleLogicalRange(),this.chart.savePosition(e),this.chart.fetchMore(e))},500))}async bindLegend(e){if(this.legendElements||(this.legendElements={}),!e){for(const e in r.state[this.chart.paneId].indicators)this.bindLegend(e);return}await R(1);const t=this.chart.paneId+e;if(this.legendElements[t])return;const i=document.getElementById(t);i&&(this.legendElements[t]=i)}unbindLegend(e){if(!this.legendElements)return;if(!e){for(const e of this.chart.loadedIndicators)this.unbindLegend(e.id);return void(this.legendElements=null)}const t=this.chart.paneId+e;for(const i in this.legendElements)if(t===i)return this.legendElements[i].innerText="",void delete this.legendElements[i]}clearChartsCrosshairs(){if(this.isSyncingCrosshairs){for(let e=0;e<b.length;e++)b[e].chartInstance.setCrosshair(null,null,null);this.isSyncingCrosshairs=!1}}updateLegend(e){for(let t=0;t<this.chart.loadedIndicators.length;t++){const i=this.chart.loadedIndicators[t];if(!i.apis.length)continue;const s=this.chart.paneId+i.id;if(!this.legendElements[s])continue;if(!e.point.x)continue;let r="";for(let t=0;t<i.apis.length&&!(t>10);t++){const s=i.apis[t],a=e.seriesData.get(s);if(r.length&&(r+=" | "),!a){r+="na";continue}let n,o="price";i.options.priceFormat&&(i.options.priceFormat.type&&(o=i.options.priceFormat.type),n=i.options.priceFormat.precision);const c="volume"===o?k:C;a.value?r+=c(a.value,n):a.close&&(r+=`O: ${c(a.open,n)} H: ${c(a.high,n)} L: ${c(a.low,n)} C: ${c(a.close,n)}`)}this.legendElements[s].textContent=r}}async toggleTimeframeDropdown(e){const t={value:e.currentTarget,paneId:this.chart.paneId};if(y.timeframeDropdown)y.timeframeDropdown.value===e.currentTarget?y.timeframeDropdown.value=null:(y.timeframeDropdown.paneId=t.paneId,y.timeframeDropdown.value=t.value);else{const e=await f(()=>import("./TimeframeDropdown.5c4cb14.js"),["TimeframeDropdown.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","TimeframeDropdown.5c4cb14.css"]);y.timeframeDropdown=g(e.default,t),v(y.timeframeDropdown),y.timeframeDropdown.$on("input",e=>{y.timeframeDropdown.value=e})}}}const Ie={time:({trade:e,timeframe:t,isOdd:i})=>n(e.timestamp/1e3,t,i),tick:({renderer:e,timeframe:t,trade:i})=>e.bar.cbuy+e.bar.csell>=t?Math.max(e.timestamp+.001,Math.round(i.timestamp/1e3)):e.timestamp,vol:({renderer:e,timeframe:t,trade:i})=>e.bar.vbuy+e.bar.vsell>=t?Math.max(e.timestamp+.001,Math.round(i.timestamp/1e3)):e.timestamp,bps({renderer:e,trade:t,marketsFilters:i,timeframe:s}){const{count:r,sum:a}=Object.keys(e.sources).reduce((t,s)=>i[s]&&null!==e.sources[s].open?(t.sum+=e.sources[s].close,t.count++,t):t,{count:0,sum:0}),n=a/r,o=(n-e.bar.close)/e.bar.close*100*100;return!e.bar.close||Math.abs(o)>s?(e.bar.close=n,Math.max(e.timestamp+.001,Math.round(t.timestamp/1e3))):e.timestamp}};function be(e){return null!==e.close&&(e.open=e.close,e.high=e.close,e.low=e.close),e.vbuy=0,e.vsell=0,e.cbuy=0,e.csell=0,e.lbuy=0,e.lsell=0,e.empty=!0,e}function ye(e,t){return{pair:e.pair,exchange:e.exchange,time:t||e.time,open:e.open,high:e.high,low:e.low,close:e.close,vbuy:e.vbuy,vsell:e.vsell,cbuy:e.cbuy,csell:e.csell,lbuy:e.lbuy,lsell:e.lsell}}function Se(e,t,i,s,r,a,n){e.sources[t]={pair:i,exchange:s,close:r,active:a},be(e.sources[t]),n&&async function(e,t,i,s,r){e.bars[t]={...be({close:r}),pair:s,exchange:i,cbuy:1,csell:1}}(n,t,s,i,r)}let _e=class{constructor(e,i){t(this,"paneId"),t(this,"watermark"),t(this,"chartCache"),t(this,"chartControl"),t(this,"chartInstance"),t(this,"chartElement"),t(this,"loadedIndicators",[]),t(this,"panPrevented"),t(this,"activeRenderer"),t(this,"renderedRange",{from:null,to:null}),t(this,"marketsFilters",{}),t(this,"marketsIndexes",[]),t(this,"mainIndex"),t(this,"timezoneOffset",0),t(this,"fillGapsWithEmpty",!0),t(this,"timeframe"),t(this,"isOddTimeframe"),t(this,"type"),t(this,"priceScales",[]),t(this,"isLoading",!1),t(this,"hasReachedEnd",!1),t(this,"isPrepending",!1),t(this,"isSyncingCrosshair",!1),t(this,"prepend",{bars:{},time:null}),t(this,"activeChunk"),t(this,"queuedTrades",[]),t(this,"historicalMarkets"),t(this,"seriesIndicatorsMap",{}),t(this,"previousLogicalRange"),t(this,"axis",{top:0,left:0,right:0,time:0}),t(this,"_releaseQueueInterval"),t(this,"_releasePanTimeout"),t(this,"_queueHandler",this.releaseQueue.bind(this)),t(this,"_refreshDecimalsHandler",this.refreshAutoDecimals.bind(this)),t(this,"_promiseOfMarkets"),t(this,"_promiseOfMarketsRender"),t(this,"_priceIndicatorId"),t(this,"_priceApi"),t(this,"_alertsRendered"),t(this,"_timeToRecycle"),t(this,"_recycleTimeout"),this.paneId=e,this.chartElement=i,this.chartCache=new ue,this.initialize()}initialize(){this.createChart(),this.setupQueue(),this.setupRecycle(),this.setTimeframe(r.state[this.paneId].timeframe),this.setTimezoneOffset(r.state.settings.timezoneOffset),this.refreshMarkets(),this.fetch(),T.on("decimals",this._refreshDecimalsHandler),this.fillGapsWithEmpty=Boolean(r.state[this.paneId].fillGapsWithEmpty)}async refreshMarkets(){var e;if(r.state.app.isExchangesReady)this._promiseOfMarkets&&(this._promiseOfMarkets=null);else{if(this._promiseOfMarkets)return this._promiseOfMarkets;this._promiseOfMarkets=w(e=>e.app.isExchangesReady).then(this.refreshMarkets.bind(this))}const t=r.state.panes.panes[this.paneId].markets,i=r.state.settings.normalizeWatermarks,s=[],a={},n={};for(const o of t){const[e]=o.split(":"),t=r.state.panes.marketsListeners[o];let c=o;t&&(c=O(t.local)),n[o]=r.state.exchanges[e]&&!r.state.exchanges[e].disabled&&!r.state[this.paneId].hiddenMarkets[o],n[o]&&-1===s.indexOf(c)&&s.push(i&&t?c:o),a[c]||(a[c]=0),a[c]++}this.marketsFilters=n,this.marketsIndexes=Object.keys(a),this.historicalMarkets=me.filterOutUnavailableMarkets(t),this.isPrepending=this.marketsIndexes.length>1||"time"!==this.type,this.mainIndex=null==(e=this.marketsIndexes.reduce((e,t)=>(e.push({index:t,count:this.marketsIndexes[t]}),e),[]).sort((e,t)=>t.count-e.count)[0])?void 0:e.index,this.updateWatermark(s),this.resetPriceScales(),this.refreshAutoDecimals(),function(e,t){for(const i in e.bars)void 0===t[i]&&delete e.bars[i]}(this.prepend,this.marketsFilters),this.isPrepending&&async function(e,t){const i=await T.getAllTickers();for(const s in i){const r=i[s].price;if(!r||void 0===t[s])continue;const[a,n]=o(s);e.bars[s]={time:e.time,close:r,high:r,low:r,open:r,exchange:a,pair:n}}}(this.prepend,this.marketsFilters)}setTimeframe(e){const t=e[e.length-1];this.type="t"===t?"tick":"b"===t?"bps":"v"===t?"vol":"time",this.timeframe=parseFloat(e),this.isOddTimeframe=c(this.timeframe),this.previousLogicalRange=null,this.updateWatermark()}setTimezoneOffset(e){const t=this.timezoneOffset;this.timezoneOffset=e/1e3;const i=this.timezoneOffset-t;this.activeRenderer&&(this.activeRenderer.localTimestamp+=i)}createChart(){const e=M(J(Z,this.paneId),ee(this.paneId),Y(this.paneId),te(this.paneId,this.chartElement.clientWidth));this.chartInstance=ie(this.chartElement,e),this.addPaneIndicators(),this.updateWatermark(),this.updateFontSize(),this.chartControl||(this.chartControl=new ve(this)),this.chartControl.bindEvents()}removeChart(){for(this.chartControl.unbindEvents(),this.priceScales.splice(0,this.priceScales.length);this.loadedIndicators.length;)this.removeIndicator(this.loadedIndicators[0]);this.chartInstance&&(this.chartInstance=null,this.chartElement.innerHTML="")}getLoadedIndicator(e){for(let t=0;t<this.loadedIndicators.length;t++)if(this.loadedIndicators[t].id===e)return this.loadedIndicators[t]}setIndicatorOption(e,t,i,s=!1){const r=this.getLoadedIndicator(e);if(r&&(r.options[t]=i,!s))if("visible"!==t){"priceFormat"===t&&i.auto&&setTimeout(()=>this.refreshAutoDecimals(null,e));for(let e=0;e<r.apis.length;e++)r.apis[e].applyOptions({[t]:i});"priceScaleId"===t&&this.ensurePriceScale(r.options),r.model.options[t]&&r.model.options[t].rebuild?(this.refreshIndicatorAdapter(r,this.activeRenderer),this.redrawIndicator(e)):this.optionRequiresRedraw(t)&&this.redrawIndicator(e)}else this.toggleIndicatorVisibility(r,i)}toggleIndicatorVisibility(e,t){t?(e.model?this.createIndicatorSeries(e):this.prepareIndicator(e),this.redrawIndicator(e.id)):this.removeIndicatorSeries(e)}optionRequiresRedraw(e){if(/upColor|downColor|wickDownColor|wickUpColor|borderDownColor|borderUpColor|compositeOperation|src|priceScaleId/i.test(e))return!0;return!/color|priceFormat|linetype|width|style/i.test(e)}rebuildIndicator(e){this.removeIndicator(this.getLoadedIndicator(e)),this.addIndicator(e)&&this.redrawIndicator(e)}getReferencedIndicators(e){return e.model.references.slice().map(e=>e.indicatorId).filter((e,t,i)=>i.indexOf(e)===t)}redrawIndicator(e,t,i){const s=this.getLoadedIndicator(e);this.clearIndicatorSeries(s);let r=[];for(const a of this.chartCache.chunks)r=t||i?r.concat(a.bars.filter(e=>(!t||e.time>=t)&&(!i||e.time<i))):r.concat(a.bars);this.renderBars(r,e)}getVisibleRange(){const e=this.chartInstance.timeScale().getVisibleRange();return e?(e.from-=this.timezoneOffset,e.to-=this.timezoneOffset,e):e}addPaneIndicators(){for(const e of r.state[this.paneId].indicatorOrder)this.addIndicator(e)}updateWatermark(e){if(e)if(e.length)if(r.state.settings.normalizeWatermarks)this.watermark=e.join(" | ");else{const t=e.length-3;this.watermark=e.slice(0,3).join(" + ")+(t>0?" + "+t+" other"+(t>1?"s":""):"")}else this.watermark="Empty";this.chartInstance&&this.chartInstance.applyOptions({watermark:{text:`    ${this.watermark+" | "+x(r.state[this.paneId].timeframe)}    `,...ee(this.paneId).watermark}})}updateFontSize(){if(!this.chartElement)return;const e=se(this.paneId);this.chartInstance.applyOptions({layout:{fontSize:e},watermark:{fontSize:Math.max(16,Math.min(144,10*e))}})}addIndicator(e,t){if(this.getLoadedIndicator(e))return!0;if(t>5)return!1;const i=r.state[this.paneId].indicators[e],s=i.options||{},a={id:e,libraryId:i.libraryId||e,options:{...JSON.parse(JSON.stringify(s)),priceScaleId:s.priceScaleId||"right"},script:i.script,model:null,adapter:null,apis:[]};try{this.prepareIndicator(a)}catch(n){return"indicator-required"!==n.status||this.resolveDependency(a.id,n.serieId,t||0)||S.confirm({title:"Referenced indicator",message:`The <code class="-filled">${a.libraryId}</code> indicator you added requires the <code class="-filled">$${n.serieId}</code> series, but it was not located among the added indicators.`,html:!0,cancel:!1}),n.status||S.isDialogOpened("indicator")||S.openIndicator(this.paneId,a.id),!1}return this.loadedIndicators.push(a),!0}resolveDependency(e,t,i){const s=r.state[this.paneId].indicators;for(const r in s)if(r!==e&&s[r].series&&-1!==s[r].series.indexOf(t))return!!this.addIndicator(r,i+1)&&(0===i&&this.addIndicator(e,i+1),!0);return!(!s[t]||!this.addIndicator(s[t].id,i+1))&&(0===i&&this.addIndicator(e,i+1),!0)}prepareIndicator(e){try{const t=re(e,this.seriesIndicatorsMap);r.state[this.paneId].indicatorsErrors[e.id]&&r.commit(this.paneId+"/SET_INDICATOR_ERROR",{id:e.id,error:null}),e.model=t,e.options=Object.keys(t.options).reduce((i,s)=>(i[s]=void 0!==e.options[s]?e.options[s]:t.options[s].default,i),e.options),r.commit(this.paneId+"/SET_INDICATOR_OPTIONS_DEFINITIONS",{id:e.id,optionsDefinitions:t.options}),!1!==e.options.visible&&this.createIndicatorSeries(e)}catch(t){throw!1!==e.options.visible&&r.commit(this.paneId+"/SET_INDICATOR_ERROR",{id:e.id,error:t.message}),t}}bindIndicator(e,t){if(t&&void 0===t.indicators[e.id]&&e.model){if(t.indicators[e.id]=ae(e),t.minLength=Object.values(t.indicators).reduce((e,t)=>e+t.minLength||0,0),!this.activeRenderer||t===this.activeRenderer){for(let i=0;i<t.indicators[e.id].plotsOptions.length;i++)e.apis[i].applyOptions(t.indicators[e.id].plotsOptions[i]);this.refreshIndicatorAdapter(e,t)}return this.prepareRendererForIndicators(e,t),e}}refreshIndicatorAdapter(e,t){try{e.adapter=ne(e.model,this.marketsFilters,e.options)}catch(i){throw this.unbindIndicator(e,t),i}}refreshAllIndicatorAdapters(){for(const e of this.loadedIndicators)this.refreshIndicatorAdapter(e,this.activeRenderer)}unbindIndicator(e,t){t&&void 0!==t.indicators[e.id]&&delete t.indicators[e.id]}ensurePriceScale(e){const{priceScaleId:t,scaleMargins:i}=e;-1===this.priceScales.indexOf(t)&&this.priceScales.push(t);let s=r.state[this.paneId].priceScales[t];s&&(!i||s.scaleMargins&&i.top===s.scaleMargins.top&&i.bottom===s.scaleMargins.bottom)||(s||(s={}),s.scaleMargins=i||{top:.1,bottom:.2},r.commit(this.paneId+"/SET_PRICE_SCALE",{id:t,priceScale:s})),this.refreshPriceScale(t)}resetPriceScales(){for(let t=0;t<this.priceScales.length;t++)try{this.chartInstance.priceScale(this.priceScales[t]).applyOptions({autoScale:!0})}catch(e){}}removeIndicator(e){"string"==typeof e&&(e=this.getLoadedIndicator(e)),e&&(this.removeIndicatorSeries(e),this.loadedIndicators.splice(this.loadedIndicators.indexOf(e),1))}moveIndicator(e,t){const i=this.loadedIndicators.findIndex(t=>t.id===e);if(-1===i)return;const[s]=this.loadedIndicators.splice(i,1),r=Math.min(t,this.loadedIndicators.length);this.loadedIndicators.splice(r,0,s);for(const a of this.loadedIndicators)this.removeIndicatorSeries(a);for(const a of this.loadedIndicators)this.createIndicatorSeries(a);this.renderAll()}clearChart(e){e||this.preventPan();for(const t of this.loadedIndicators)this.clearIndicatorSeries(t);this._alertsRendered=!1,this.renderedRange.from=this.renderedRange.to=null}clearData(){this.activeRenderer=null,this.activeChunk=null,this.queuedTrades.splice(0,this.queuedTrades.length)}clearPriceLines(e){for(let t=0;t<this.loadedIndicators.length;t++)if(!e||-1!==e.indexOf(this.loadedIndicators[t].id)){this._priceIndicatorId===this.loadedIndicators[t].id&&(this._alertsRendered=!1);for(let e=0;e<this.loadedIndicators[t].apis.length;e++)this.loadedIndicators[t].apis[e].removeAllPriceLines()}}clear(){this.chartCache.clear(),this.clearData(),this.clearChart(),this.hasReachedEnd=!1,this.setTimeframe(r.state[this.paneId].timeframe)}getActiveChunk(){return this.activeChunk||this.chartCache.cacheRange.to!==this.activeRenderer.timestamp?(this.activeChunk&&(this.activeChunk.active=!1),this.activeChunk=this.chartCache.saveChunk({from:this.activeRenderer.timestamp,to:this.activeRenderer.timestamp,active:!0,rendered:!0,bars:[]})):(this.activeChunk=this.chartCache.chunks[this.chartCache.chunks.length-1],this.activeChunk.active=!0),this.activeChunk}destroy(){this.chartCache.clear(),this.clearData(),this.clearChart(),this.removeChart(),this.clearQueue(),this.clearRecycle(),T.off("decimals",this._refreshDecimalsHandler)}clearIndicatorSeries(e){e.id===this._priceIndicatorId&&(this._priceIndicatorId=null,this._priceApi=null);for(let t=0;t<e.apis.length;t++)e.apis[t].removeAllPriceLines(),e.apis[t].setData([])}setupQueue(){this._releaseQueueInterval||(r.state[this.paneId].refreshRate?this._releaseQueueInterval=setInterval(this._queueHandler,r.state[this.paneId].refreshRate):this._releaseQueueInterval=requestAnimationFrame(this._queueHandler))}clearQueue(){this._releaseQueueInterval&&(clearInterval(this._releaseQueueInterval),cancelAnimationFrame(this._releaseQueueInterval),delete this._releaseQueueInterval,this.releaseQueue())}releaseQueue(){if(this.queuedTrades.length)try{this.renderRealtimeTrades(this.queuedTrades)}catch(e){}finally{this.queuedTrades.splice(0,this.queuedTrades.length)}}queueTrades(e){Array.prototype.push.apply(this.queuedTrades,e),r.state[this.paneId].refreshRate||(this._releaseQueueInterval=requestAnimationFrame(this._queueHandler))}renderRealtimeTrades(e){if(!e.length)return;let t=!1;for(let i=0;i<e.length;i++){const s=e[i],r=s.exchange+":"+s.pair;if(void 0===this.marketsFilters[r])continue;let a;if(a=this.activeRenderer?Ie[this.activeRenderer.type]({renderer:this.activeRenderer,timeframe:this.timeframe,trade:s,isOdd:this.isOddTimeframe,marketsFilters:this.marketsFilters}):s.timestamp/1e3,!this.activeRenderer||this.activeRenderer.timestamp<a)if(this.activeRenderer){(!this.activeChunk||this.activeChunk.to<this.activeRenderer.timestamp&&this.activeChunk.bars.length>=L)&&this.getActiveChunk(),this.activeRenderer.bar.empty||this.updateBar(this.activeRenderer);for(const e in this.activeRenderer.sources)!1===this.activeRenderer.sources[e].empty&&this.activeChunk.bars.push(ye(this.activeRenderer.sources[e],this.activeRenderer.timestamp));this.activeChunk.to=this.chartCache.cacheRange.to=this.activeRenderer.timestamp,this.renderedRange.to<this.activeRenderer.timestamp&&(this.renderedRange.to=this.activeRenderer.timestamp),this.nextBar(a,this.activeRenderer)}else this.activeRenderer=this.createRenderer(a);s.timestamp&&(this.activeRenderer.lastTradeTimestamp=s.timestamp/1e3),this.activeRenderer.sources[r]&&void 0!==this.activeRenderer.sources[r].pair||(Se(this.activeRenderer,r,s.pair,s.exchange,+s.price,this.marketsFilters[r],this.isPrepending&&this.prepend),t=!0);const n=this.marketsFilters[r];s.liquidation?(this.activeRenderer.sources[r]["l"+s.side]+=s.amount,this.activeRenderer.bar.empty=!1,n&&(this.activeRenderer.bar["l"+s.side]+=s.amount)):(this.activeRenderer.sources[r].close=+s.price,this.activeRenderer.sources[r].empty?this.activeRenderer.sources[r].open=this.activeRenderer.sources[r].high=this.activeRenderer.sources[r].low=this.activeRenderer.sources[r].close:(this.activeRenderer.sources[r].high=Math.max(this.activeRenderer.sources[r].high,this.activeRenderer.sources[r].close),this.activeRenderer.sources[r].low=Math.min(this.activeRenderer.sources[r].low,this.activeRenderer.sources[r].close)),this.activeRenderer.sources[r]["c"+s.side]+=s.count,this.activeRenderer.sources[r]["v"+s.side]+=s.amount,this.activeRenderer.sources[r].empty=!1,n&&(this.activeRenderer.bar["v"+s.side]+=s.amount,this.activeRenderer.bar["c"+s.side]+=s.count,this.activeRenderer.bar.empty=!1))}!this.activeRenderer||this.activeRenderer.bar.empty||t?t&&this.renderAll():(this.updateBar(this.activeRenderer),this.renderedRange.to<this.activeRenderer.timestamp&&(this.renderedRange.to=this.activeRenderer.timestamp))}renderBars(e,t,i){if(function(e,t){if(e.length){if(t&&t.timestamp>e[e.length-1].time){const i=Object.values(t.sources).filter(e=>!1===e.empty);for(let s=0;s<i.length;s++){const r=i[s];r.time=t.timestamp;for(let a=e.length-1;a>=0;a--){const n=e[a];if(n.time<t.timestamp){e.splice(a+1,0,r),i.splice(s,1),s--;break}if(n.exchange===r.exchange&&n.pair===r.pair){n.vbuy+=r.vbuy,n.vsell+=r.vsell,n.cbuy+=r.cbuy,n.csell+=r.csell,n.lbuy+=r.lbuy,n.lsell+=r.lsell,n.open=r.open,n.high=r.high,n.low=r.low,n.close=r.close,i.splice(s,1),s--;break}}}}}else t&&t.bar&&!t.bar.empty&&Array.prototype.push.apply(e,Object.values(t.sources).filter(e=>!1===e.empty))}(e,this.activeRenderer),!e.length)return;const{barCount:s,from:r,to:a,temporaryRenderer:n,computedSeries:o,indicatorsIds:c}=this.computeBars(e,t);if(this.clearPriceLines(c),this.activeRenderer){this.activeRenderer.bar={...n.bar,close:this.activeRenderer.bar.close};for(const e in n.indicators)this.activeRenderer.indicators[e]=n.indicators[e];for(const e in n.sources)this.activeRenderer.sources[e]=n.sources[e]}else this.activeRenderer=n;this.replaceData(o,i),setTimeout(this.renderAlerts.bind(this)),c&&c.length||(this.activeRenderer&&(this.activeRenderer.length=s),e.length?(this.renderedRange.from=r,this.renderedRange.to=a):this.renderedRange.from=this.renderedRange.to=null)}computeBars(e,t){let i,s=!1;if(t){const e=this.getLoadedIndicator(t);"left"!==e.options.priceScaleId&&"right"!==e.options.priceScaleId||(s=!0),i=[...this.getReferencedIndicators(e),t]}const r={};let a,n=null,o=null,c=0;for(let h=0;h<=e.length;h++){const l=e[h];if(!l||!a||l.time>a.timestamp){if(a){null===n&&(n=a.timestamp),o=a.timestamp;const e=this.computeBar(a,i);for(const a in e)!s&&i&&t!==a&&-1!==i.indexOf(a)||(void 0===r[a]&&(r[a]=[]),r[a].push(e[a]))}if(!l)break;if(c++,a){if(this.fillGapsWithEmpty&&"time"===a.type){const e=(l.time-a.timeframe-a.timestamp)/a.timeframe;if(e>0)for(let t=0;t<e;t++){this.incrementRendererBar(a);for(const e in r)"broken-area"!==this.seriesIndicatorsMap[e].plotType&&r[e].push({time:a.localTimestamp});c++}}this.nextBar(l.time,a)}else a=this.createRenderer(l.time||this.activeRenderer.timestamp,i)}const d=l.exchange+":"+l.pair,p=this.marketsFilters[d];p&&!l.empty&&(a.bar.empty=!1,a.bar.vbuy+=l.vbuy,a.bar.vsell+=l.vsell,a.bar.cbuy+=l.cbuy,a.bar.csell+=l.csell,a.bar.lbuy+=l.lbuy,a.bar.lsell+=l.lsell),a.sources[d]=ye(l),a.sources[d].empty=!1,a.sources[d].active=p}return{from:n,to:o,barCount:c,temporaryRenderer:a,computedSeries:r,indicatorsIds:i}}removeIndicatorSeries(e){if(this.chartInstance)for(let t=0;t<e.apis.length;t++)this.chartInstance.removeSeries(e.apis[t]),delete this.seriesIndicatorsMap[e.apis[t].id],e.apis.splice(t--,1);this.unbindIndicator(e,this.activeRenderer);void 0===this.loadedIndicators.find(t=>t.id!==e.id&&!1!==t.options.visible&&t.options.priceScaleId===e.options.priceScaleId)&&this.priceScales.splice(this.priceScales.indexOf(e.options.priceScaleId),1)}createIndicatorSeries(e){if(!e.model)return;const t=[],i=r.state[this.paneId].priceScales[e.options.priceScaleId];for(let s=0;s<e.model.plots.length;s++){const r=e.model.plots[s],a=A("add-"+r.type+"-series"),n=oe(e,e.model.plots[s],i),o=this.chartInstance[a](oe(e,e.model.plots[s]));o.id=r.id,this.seriesIndicatorsMap[r.id]={indicatorId:e.id,plotIndex:s,plotType:r.type},t.push(r.id),e.apis.push(o),this.ensurePriceScale(n)}r.commit(this.paneId+"/SET_INDICATOR_SERIES",{id:e.id,series:t}),this.bindIndicator(e,this.activeRenderer)}refreshPriceScale(e){const t=r.state[this.paneId].priceScales[e];this.chartInstance.priceScale(e).applyOptions({scaleMargins:t.scaleMargins,mode:t.mode})}preventPan(){if(this.panPrevented)return;void 0!==this._releasePanTimeout&&clearTimeout(this._releasePanTimeout),this.panPrevented=!0,this._releasePanTimeout=window.setTimeout(()=>{this.panPrevented=!1},100)}async renderAll(e){if(!this.chartInstance)return;if(this._promiseOfMarkets)return this._promiseOfMarketsRender||(this._promiseOfMarketsRender=this._promiseOfMarkets.then(()=>{this._promiseOfMarketsRender=null,this.renderAll(!0)})),this._promiseOfMarketsRender;const t=this.chartInstance.timeScale().scrollPosition();this.clearChart(e),this.renderBars(this.chartCache.chunks.length?this.chartCache.chunks.reduce((e,t)=>e.concat(t.bars),[]):[],null,!e),t&&this.chartInstance.timeScale().scrollToPosition(t,!1)}async renderAlerts(){if(this._alertsRendered||!r.state.settings.alerts||!r.state[this.paneId].showAlerts)return;const e=this.getPriceApi();if(e){for(const t of this.marketsIndexes){const i=await l.getAlerts(t);for(let t=0;t<i.length;t++)this.renderAlert(i[t],e)}this._alertsRendered=!0}}onAlert({timestamp:e,price:t,market:i,type:s,newPrice:a}){if(-1===this.marketsIndexes.indexOf(i))return;const n=l.alerts[i].find(e=>e.price===t),o=this.getPriceApi();if(!o)return;const c=this.chartInstance.timeScale();let h;c&&e&&(h=c.coordinateToLogical(c.timeToCoordinate(e)));const d=o.getPriceLine(a||t,h);switch(s){case D.DELETED:d&&o.removePriceLine(d);break;case D.UPDATED:d&&o.removePriceLine(d),this.renderAlert({...n,price:a},o);break;case D.TRIGGERED:r.state.settings.alertSound&&H.playOnce(r.state.settings.alertSound),d&&o.removePriceLine(d),this.renderAlert(n,o);break;case D.CREATED:d&&o.removePriceLine(d),this.renderAlert({timestamp:e,price:t,market:i},o,.5);break;case D.ACTIVATED:d&&o.removePriceLine(d),this.renderAlert(n,o);break;case D.DEACTIVATED:d&&o.removePriceLine(d),this.renderAlert(n,o,.5)}}renderAlert(e,t,i){if(!t)return;let s;if(e.timestamp){const t=n(e.timestamp,this.timeframe);s=this.chartInstance.timeScale().coordinateToLogical(this.chartInstance.timeScale().timeToCoordinate(t))}const a=r.state[this.paneId].showAlertsLabel;let o="";a&&e.message&&e.message.length<3&&(o=e.message);let c=r.state.settings.alertsColor;if(e.triggered&&(o+="✔"),i||e.triggered){const e=d(c);e[3]=(e[3]||1)*(i||.5),c=p(e)}return t.createPriceLine({market:e.market,message:e.message,index:s,price:e.price,lineWidth:r.state.settings.alertsLineWidth,lineStyle:r.state.settings.alertsLineStyle,color:c,title:o.length?o:null,axisLabelVisible:a})}replaceData(e,t){t&&this.preventPan();for(let s=this.loadedIndicators.length-1;s>=0;s--)if(!1!==this.loadedIndicators[s].options.visible)for(let t=0;t<this.loadedIndicators[s].apis.length;t++){const a=this.loadedIndicators[s].apis[t].id;if(e[a])try{this.loadedIndicators[s].apis[t].setData(e[a])}catch(i){r.commit(this.paneId+"/SET_INDICATOR_ERROR",{id:this.loadedIndicators[s].id,error:i.message}),this.setIndicatorOption(this.loadedIndicators[s].id,"visible",!1)}}}updateBar(e){this.preventPan();const t=[];for(let i=0;i<this.loadedIndicators.length;i++){if(!1===this.loadedIndicators[i].options.visible)continue;const s=this.loadedIndicators[i],r=e.indicators[s.id];if(this.loadedIndicators[i].adapter(e,r.functions,r.variables,s.apis,s.options,ce),r.canRender)for(let i=0;i<s.apis.length;i++){const r=e.series[s.apis[i].id];if(r&&!r.rendered){if("line"===s.model.plots[i].type&&!r.value||"histogram"===s.model.plots[i].type&&!r.value||("cloudarea"===s.model.plots[i].type||"brokenarea"===s.model.plots[i].type)&&null===r.lowerValue||"histogram"===s.model.plots[i].type&&!r.value)continue;t.push([s.apis[i],r])}}}for(let i=0;i<t.length;i++)t[i][0].update(t[i][1]),t[i][1].rendered=!0}computeBar(e,t){const i={};e.series={};for(let a=0;a<this.loadedIndicators.length;a++){if(t&&-1===t.indexOf(this.loadedIndicators[a].id)||!1===this.loadedIndicators[a].options.visible)continue;const n=this.loadedIndicators[a],o=e.indicators[n.id];try{n.adapter(e,o.functions,o.variables,n.apis,n.options,ce)}catch(s){throw r.commit(this.paneId+"/SET_INDICATOR_ERROR",{id:n.id,error:s.message}),new Error("execution failed")}for(let t=0;t<n.apis.length;t++){const s=e.series[n.apis[t].id];!s||void 0!==s.value&&null===s.value||void 0!==s.lowerValue&&null===s.lowerValue||n.model.plots[t]&&"histogram"===n.model.plots[t].type&&0===s.value||(i[n.apis[t].id]=s)}}return i}getPriceApi(){if(this._priceApi)return this._priceApi;const e=this.loadedIndicators.find(e=>"price"===e.id||"price"===e.libraryId);if(e&&!1!==e.options.visible)return this._priceIndicatorId=e.id,this._priceApi=e.apis[0],this._priceApi;for(let t=0;t<this.loadedIndicators.length;t++)for(let e=0;e<this.loadedIndicators[t].apis.length;e++){const i=this.loadedIndicators[t].apis[e];if("right"===i.options().priceScaleId)return this._priceIndicatorId=this.loadedIndicators[t].id,this._priceApi=i,this._priceApi}}createRenderer(e,t){const i={timestamp:e=n(e,this.timeframe),localTimestamp:e+this.timezoneOffset,timeframe:this.timeframe,minLength:0,type:this.type,length:1,indicators:{},sources:{},series:{},bar:{vbuy:0,vsell:0,cbuy:0,csell:0,lbuy:0,lsell:0,empty:!0}};if(this.isPrepending){const t=function(e,t){if(e.time===t)return e.bars;for(const i in e.bars)e.bars[i].time=t;return e.time=t,e.bars}(this.prepend,e);for(const e in t)i.sources[e]={...t[e],active:this.marketsFilters[e]}}this.loadedIndicators=this.loadedIndicators.sort((e,t)=>(e.model?e.model.references.length:0)-(t.model?t.model.references.length:0));for(const s of this.loadedIndicators)t&&-1===t.indexOf(s.id)||!1===s.options.visible||this.bindIndicator(s,i);return i}nextBar(e,t){if(this.fillGapsWithEmpty&&t===this.activeRenderer&&"time"===this.activeRenderer.type&&this.activeRenderer.timestamp<e-this.activeRenderer.timeframe){const i=(e-this.activeRenderer.timeframe-this.activeRenderer.timestamp)/this.activeRenderer.timeframe;for(let e=0;e<i;e++){this.incrementRendererBar(t);for(let e=0;e<this.loadedIndicators.length;e++)for(let i=0;i<this.loadedIndicators[e].apis.length;i++)this.loadedIndicators[e].apis[i].update({time:t.localTimestamp})}}this.incrementRendererBar(t),function(e){if(e.bar={...e.bar,vbuy:0,vsell:0,cbuy:0,csell:0,lbuy:0,lsell:0,empty:!0},void 0!==e.sources)for(const t in e.sources)be(e.sources[t])}(t),t.timestamp=e,t.localTimestamp=e+this.timezoneOffset}incrementRendererBar(e){e.length++,e.timestamp+=e.timeframe,e.localTimestamp+=e.timeframe,e.price=null;for(let t=0;t<this.loadedIndicators.length;t++){const i=e.indicators[this.loadedIndicators[t].id];if(i){i.canRender=e.length>=i.minLength;for(let e=0;e<i.functions.length;e++){const t=i.functions[e];"function"==typeof ce[t.name].next&&ce[t.name].next(t)}for(let e=0;e<i.variables.length;e++){const t=i.variables[e];t.length>1&&(t.state.unshift(t.state[0]),t.state.length>t.length&&t.state.pop())}}}}prepareRendererForIndicators(e,t){let i=Object.keys(e.model.markets);e.model.sources.length&&(i=Object.keys(this.marketsFilters).concat(i).filter((e,t,i)=>i.indexOf(e)===t));for(let s=0;s<i.length;s++){t.sources[i[s]]||(t.sources[i[s]]={open:null,high:null,low:null,close:null});let r=e.model.markets[i[s]]||[];if(e.model.sources.length&&(r=e.model.sources.map(e=>e.prop).concat(r).filter((e,t,i)=>i.indexOf(e)===t)),r.length)for(let e=0;e<r.length;e++)void 0===t.sources[i[s]][r[e]]&&"open"!==r[e]&&"high"!==r[e]&&"low"!==r[e]&&"close"!==r[e]&&(t.sources[i[s]][r[e]]=0)}}toggleFillGapsWithEmpty(){this.fillGapsWithEmpty=!this.fillGapsWithEmpty,this.renderAll()}refreshAutoDecimals(e,t){if(e&&-1===e.indexOf(this.mainIndex))return;const i=$[this.mainIndex];for(let s=0;s<this.loadedIndicators.length;s++){if(t&&t!==this.loadedIndicators[s].id)continue;let e=this.loadedIndicators[s].options.priceFormat||{type:"price"};const a="number"==typeof i?i:"number"==typeof e.precision?e.precision:2;if(!e.auto||"volume"===e.type||e.precision===a)continue;const n={precision:a,minMove:1/Math.pow(10,a)};e={...e,...n,auto:!0},r.dispatch(this.paneId+"/setIndicatorOption",{id:this.loadedIndicators[s].id,key:"priceFormat",value:e,silent:!0});const o=r.state[this.paneId].priceScales[this.loadedIndicators[s].options.priceScaleId];r.commit(this.paneId+"/SET_PRICE_SCALE",{id:this.loadedIndicators[s].options.priceScaleId,priceScale:{...o,priceFormat:n}});for(let t=0;t<this.loadedIndicators[s].apis.length;t++)this.loadedIndicators[s].apis[t].applyOptions({priceFormat:n})}}getPrice(){if(!this.activeRenderer)return null;if(this.activeRenderer.series.price){if(this.activeRenderer.series.price.close)return this.activeRenderer.series.price.close;if(this.activeRenderer.series.price.value)return this.activeRenderer.series.price.value}return this.activeRenderer.price||(this.activeRenderer.price=+ce.avg_close.update({},this.activeRenderer).toFixed(8)),this.activeRenderer.price}getChartCanvas(){return this.chartElement.querySelector("tr:first-child td:nth-child(2) canvas:nth-child(2)")}flipChart(){const e=this.getPriceApi(),t=e.priceScale().options().invertScale;e.priceScale().applyOptions({invertScale:!t})}takeScreenshot(e){if(e.shiftKey)return void G(this.chartElement.querySelector("tr:first-child td:nth-child(2) canvas"));const t=this.chartInstance.takeScreenshot(),i=document.createElement("canvas"),s=i.getContext("2d"),a=r.state.panes.panes[this.paneId].zoom||1,n=window.devicePixelRatio||1,o=16*a*n;let c=12*a*n;t.width*t.height<4e4&&(c=6),i.width=t.width,s.font=`${c}px Spline Sans Mono`,s.textAlign="left",s.textBaseline="top";const h=[],[l,m]=(new Date).toISOString().split("T"),u=l+" "+m.split(".")[0]+" UTC",f=this.watermark,g=x(r.state[this.paneId].timeframe);t.width>500?h.push([f,g,u].join(" | ")):(h.push(u),h.push([f,g].join(" | ")));const v=Math.round(c);i.height=t.height;const I=getComputedStyle(document.documentElement),b=I.getPropertyValue("--theme-base"),y=d(b),S=p([y[0],y[1],y[2],.75]),_=I.getPropertyValue("--theme-color-base"),E=r.state.settings.backgroundColor;e.shiftKey||(s.fillStyle=b,s.fillRect(0,0,i.width,i.height),s.fillStyle=E,s.fillRect(0,0,i.width,i.height)),s.fillStyle="light"===r.state.settings.theme?"rgba(255,255,255,.2)":"rgba(0,0,0,.2)",s.fillRect(0,0,i.width,i.height),s.drawImage(t,0,0),s.fillStyle=_,s.font=`${c}px Spline Sans Mono`,s.textAlign="left",s.textBaseline="top";let R=0;for(let r=0;r<h.length;r++)s.strokeStyle=S,s.lineWidth=4*n,s.lineJoin="round",s.strokeText(h[r],o,o+R),s.fillText(h[r],o,o+R),R+=1.2*v*(r+1);R+=2*o,r.state[this.paneId].showIndicators&&Object.values(r.state[this.paneId].indicators).forEach(e=>{const t=e.options;if(!1===t.visible)return;let i=t.color||t.upColor||_;try{i=d(i),void 0!==i[3]&&(i[3]=1),i=p(i)}catch(a){}const r=e.displayName||e.name;s.fillStyle=_,s.strokeStyle=S,s.lineWidth=4*n,s.fillStyle=i,s.lineJoin="round",s.strokeText(r,o,R),s.fillText(r,o,R),R+=1.2*v}),i.toBlob(e=>{if(!e||!window.ClipboardItem)return void G(i);const t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t]).then(()=>{},e=>{}).finally(()=>G(i))})}restart(){this.destroy(),this.initialize()}fetch(e){e||(this.hasReachedEnd=!1);const t=this.chartCache.cacheRange&&this.chartCache.cacheRange.from;if(!this.historicalMarkets.length)return;const i=+r.state[this.paneId].timeframe;if(!i)return void(this.hasReachedEnd=!0);if(-1===r.state.app.apiSupportedTimeframes.indexOf(i.toString()))return;const s=this.getVisibleRange();let a;if(e)a=e;else{let e;e=t?this.chartCache.cacheRange.from:s&&s.from?s.from+r.state.settings.timezoneOffset/1e3:Date.now()/1e3,a={from:e-20*i,to:e}}a.from=n(Math.round(a.from),i),a.to=n(Math.round(a.to),i)+i,this.chartCache.cacheRange.from&&(a.to=Math.min(n(this.chartCache.cacheRange.from,i),a.to));const o=Math.floor((a.to-a.from)/i),c=z(o*this.historicalMarkets.length*112);return r.dispatch("app/showNotice",{id:"fetching-"+this.paneId,timeout:15e3,title:`Fetching ${o*this.historicalMarkets.length} bars (~${c})`,type:"info"}),this.isLoading=!0,me.fetch(1e3*a.from,1e3*a.to,i,this.historicalMarkets).then(e=>this.onHistorical(e)).catch(e=>{this.hasReachedEnd=!0}).then(()=>{r.dispatch("app/hideNotice","fetching-"+this.paneId),setTimeout(()=>{this.isLoading=!1,this.fetchMore(this.chartInstance.timeScale().getVisibleLogicalRange())},200)})}onHistorical(e){const t={from:e.from,to:e.to,bars:e.data};this.chartCache.saveChunk(t),this.isPrepending&&function(e,t){for(const i in t.initialPrices)if(e.bars[i])e.bars[i].open=e.bars[i].high=e.bars[i].low=e.bars[i].close=t.initialPrices[i];else{const[s,r]=o(i);e.bars[i]={...be({close:t.initialPrices[i]}),pair:r,exchange:s}}}(this.prepend,e),this.renderAll(!0)}async fetchMore(e){const t=`${e.from},${e.to}`;if(this.isLoading)return;if(this.hasReachedEnd)return;if(!e)return;if(e.from>0&&this.activeRenderer.length>this.activeRenderer.minLength)return;if(this.previousLogicalRange&&this.previousLogicalRange===t)return;this.previousLogicalRange=t;let i=0;if(this.activeRenderer)for(const r in this.activeRenderer.indicators)this.activeRenderer.indicators[r].minLength&&(i=Math.max(i,this.activeRenderer.indicators[r].minLength));const s=Math.round(Math.min(Math.abs(e.from)+i,500))+1;if(!s)return;const a={from:this.chartCache.cacheRange.from-s*r.state[this.paneId].timeframe,to:this.chartCache.cacheRange.from-1};await this.fetch(a)}savePosition(e){r.commit(this.paneId+"/SET_BAR_SPACING",this.getBarSpacing(e))}getBarSpacing(e){if(!e)return Z.timeScale.barSpacing;return this.getChartCanvas().clientWidth/(e.to-e.from)}trimChart(){if(Date.now()>this._timeToRecycle){const e=this.getVisibleRange();let t;if(e){const i=this.chartInstance.timeScale().getVisibleLogicalRange();if(i){const s=i.to-i.from;(i.from<0||s>L)&&(t=this.activeRenderer&&this.renderedRange.from&&"time"===this.activeRenderer.type&&this.activeRenderer.minLength?Math.max(e.from-2*(e.to-e.from),this.renderedRange.to-this.activeRenderer.timeframe*this.activeRenderer.minLength):e.from-2*(e.to-e.from))}}this.chartCache.trim(t)&&this.renderAll(),this.setTimeToRecycle()}this._recycleTimeout=setTimeout(this.trimChart.bind(this),9e5)}setupRecycle(){this._recycleTimeout=setTimeout(this.trimChart.bind(this),18e4),this.setTimeToRecycle()}clearRecycle(){clearTimeout(this._recycleTimeout)}setTimeToRecycle(){const e=Date.now();if("time"===this.type){const t=this.getChartCanvas().clientWidth,i=this.getBarSpacing(this.chartInstance.timeScale().getVisibleLogicalRange());this._timeToRecycle=e+Math.min(864e5,1e3*this.timeframe*(t/i)/2)}this._timeToRecycle=e+9e5}async createAlertAtPrice(e,t){if(!r.state.settings.alerts){if(!(await S.confirm({title:"Alerts are disabled",message:"Enable alerts ?",ok:"Yes please"})))return;r.commit("settings/TOGGLE_ALERTS",!0)}const i={price:e,market:this.mainIndex,timestamp:t,active:!1};l.createAlert(i,this.getPrice())}async refreshChartDimensions(){if(!this.chartInstance)return;let e=0;if(!r.state.settings.autoHideHeaders){e=1.375*(r.state.panes.panes[this.paneId].zoom||1)*16}const t=this.chartElement.parentElement;this.chartInstance.resize(t.clientWidth,t.clientHeight-e)}async saveIndicatorPreview(e){const t=M(J(Z,this.paneId),te(this.paneId,840),{timeScale:{visible:!1,barSpacing:4,rightOffset:Math.ceil(10.5)},rightPriceScale:{visible:!1},leftPriceScale:{visible:!1}}),i=document.createElement("div");i.style.width="840px",i.style.height="420px",i.style.position="fixed",i.style.visibility="hidden",document.body.appendChild(i);const s=ie(i,t),a={};for(const r of this.loadedIndicators)for(let t=0;t<r.apis.length;t++){const i=r.apis[t],{id:n}=i;a[n]={original:i};const o=i.seriesType(),c=oe(r,r.model.plots[t]);a[n].copy=s[`add${o}Series`](c),a[n].copy.id=n,a[n].visible=r.id===e,r.apis[t]=a[n].copy}const{computedSeries:n}=this.computeBars(this.chartCache.chunks.length?this.chartCache.chunks.reduce((e,t)=>e.concat(t.bars),[]):[]);for(const r of this.loadedIndicators)for(let e=0;e<r.apis.length;e++){const{id:t}=r.apis[e];r.apis[e]=a[t].original}for(const r in n)a[r].copy.setData(n[r]);await R(1);for(const r in a)a[r].visible||a[r].copy.applyOptions({visible:!1});const o=s.takeScreenshot(),c=await new Promise(e=>o.toBlob(t=>e(t))),{libraryId:h}=r.state[this.paneId].indicators[e];B.saveIndicatorPreview(h,c);for(const r in a)s.removeSeries(a[r].copy);s.remove(),document.body.removeChild(i)}toggleTimeframeDropdown(e){return this.chartControl.toggleTimeframeDropdown(e)}getAxisSize(){const e=r.state[this.paneId],t={top:0,left:0,right:0,time:0};return e.showLeftScale&&(t.left=this.chartElement.querySelector("tr:first-child td:first-child canvas").clientWidth),e.showRightScale&&(t.right=this.chartElement.querySelector("tr:first-child td:last-child canvas").clientWidth),e.showTimeScale&&(t.time=this.chartElement.querySelector("tr:last-child td:nth-child(2) canvas").clientHeight),this.axis=t,this.axis}};var Ee=Object.defineProperty,Re=Object.getOwnPropertyDescriptor;let ke=class extends F{constructor(){super(...arguments),t(this,"paneId"),t(this,"priceScaleId"),t(this,"priceScale"),t(this,"top",null),t(this,"bottom",null),t(this,"roundedTop",null),t(this,"roundedBottom",null),t(this,"currentMoveId",null),t(this,"currentSide",null),t(this,"currentOrigin",null),t(this,"currentContainerHeight",null),t(this,"modes",{0:"Linear",1:"Logarithimic",2:"Percent",3:"Indexed to 100"})}created(){this.getSize()}beforeDestroy(){this.release()}getSize(){this.roundedTop=this.top=100*this.priceScale.scaleMargins.top,this.roundedBottom=this.bottom=100*this.priceScale.scaleMargins.bottom}handleResize(e,t){this.currentMoveId?this.release():(this.start(t,m(e).y),document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.release),document.addEventListener("touchmove",this.resize),document.addEventListener("touchend",this.release))}resize(e){const t=this.getPercentMove(e);t&&(this[this.currentSide]+=t*("top"===this.currentSide?1:-1),this.updateScaleMargins(e))}handleMove(e){this.currentMoveId?this.release():(this.start("both",m(e).y),document.addEventListener("mousemove",this.move),document.addEventListener("mouseup",this.release),document.addEventListener("touchmove",this.move),document.addEventListener("touchend",this.release))}move(e){const t=this.getPercentMove(e);t&&(this.top+=t,this.bottom-=t,this.updateScaleMargins(e))}release(){this.currentSide&&("both"!==this.currentSide?(document.removeEventListener("mousemove",this.resize),document.removeEventListener("touchmove",this.resize)):(document.removeEventListener("mousemove",this.move),document.removeEventListener("touchmove",this.move)),document.removeEventListener("mouseup",this.release),document.removeEventListener("touchend",this.release),this.currentMoveId=null,this.currentSide=null,this.top=this.roundedTop,this.bottom=this.roundedBottom)}updateScaleMargins(e){const t=Math.round(this.top),i=Math.round(this.bottom);this.roundedTop=Math.max(0,Math.min(100-i,t)),this.roundedBottom=Math.max(0,Math.min(i,100-t));const s={top:this.roundedTop/100,bottom:this.roundedBottom/100};this.priceScale.scaleMargins.top===s.top&&this.priceScale.scaleMargins.bottom===s.bottom||this.$emit("update",{id:this.currentMoveId,side:this.currentSide,value:s,syncable:"touchmove"!==e.type&&!e.shiftKey})}updateMode(e){this.priceScale.mode=+e,this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:this.priceScaleId,priceScale:this.priceScale})}getContainerHeight(){return parseFloat(this.$el.parentElement.clientHeight)}getPercentMove(e){const t=m(e),i=(t.y-this.currentOrigin)/this.currentContainerHeight*100;return i?(this.currentOrigin=t.y,i):null}start(e,t){this.currentMoveId=q(8),this.currentSide=e,this.currentOrigin=t,this.currentContainerHeight=this.getContainerHeight()}};ke=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?Re(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&Ee(t,i,a),a})([N({name:"ChartPriceScale",components:{DropdownButton:j},props:{paneId:{required:!0},priceScaleId:{required:!0},priceScale:{required:!0}},watch:{"priceScale.scaleMargins.top":function(){this.currentMoveId||this.getSize()},"priceScale.scaleMargins.bottom":function(){this.currentMoveId||this.getSize()}}})],ke);const Ce=V(ke,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{directives:[{name:"tippy",rawName:"v-tippy",value:{followCursor:!0},expression:"{ followCursor: true }"}],staticClass:"chart-pricescale",class:{"-active":!!e.currentSide},style:{top:e.roundedTop+"%",bottom:e.roundedBottom+"%"},attrs:{title:`<code>${e.priceScale.scaleMargins.top}</code><br><code>${e.priceScale.scaleMargins.bottom}</code>`}},[t("div",{staticClass:"chart-pricescale__content"},[t("div",{staticClass:"chart-pricescale__title pane-overlay",on:{mousedown:e.handleMove,touchstart:e.handleMove}},[t("i",{staticClass:"icon-move mr8"}),t("code",[e._v(e._s(e.priceScale.indicators.join(", ")))]),"left"===e.priceScaleId||"right"===e.priceScaleId?t("code",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"ml4",attrs:{title:`using ${e.priceScaleId} scale`}},[e._v(" "+e._s("left"===e.priceScaleId?"← LEFT":"→ RIGHT")+" ")]):e._e(),t("dropdown-button",{staticClass:"chart-pricescale__mode -small ml8 text-bold",attrs:{options:e.modes,placeholder:"linear","button-class":"badge -outline"},on:{input:function(t){return e.updateMode(t)}},model:{value:e.priceScale.mode,callback:function(t){e.$set(e.priceScale,"mode",t)},expression:"priceScale.mode"}})],1),t("div",{staticClass:"chart-pricescale__size pane-overlay",domProps:{textContent:e._s(100-e.roundedTop-e.roundedBottom+"%")}})]),t("div",{staticClass:"chart-pricescale__boundary -top",class:{"-active":"top"===e.currentSide},on:{mousedown:function(t){return e.handleResize(t,"top")},touchstart:function(t){return e.handleResize(t,"top")}}}),t("div",{staticClass:"chart-pricescale__boundary -bottom",class:{"-active":"bottom"===e.currentSide},on:{mousedown:function(t){return e.handleResize(t,"bottom")},touchstart:function(t){return e.handleResize(t,"bottom")}}})])},[],!1,null,null,null,null).exports;var Te=Object.defineProperty,we=Object.getOwnPropertyDescriptor;let Oe=class extends F{constructor(){super(...arguments),t(this,"paneId"),t(this,"layouting"),t(this,"unsyncableMoveId"),t(this,"axis"),t(this,"activePriceScales"),t(this,"_originalActivePriceScales"),t(this,"_handleEscKey")}created(){this.getActivePriceScales()}mounted(){document.body.classList.add("-unselectable"),this.bindEscKey()}beforeDestroy(){document.body.classList.remove("-unselectable"),this._handleEscKey&&document.removeEventListener("keydown",this._handleEscKey)}getActivePriceScales(){const e=this.$store.state[this.paneId].indicators;this.activePriceScales=Object.keys(e).reduce((t,i)=>{if("string"==typeof this.layouting&&i!==this.layouting)return t;const s=e[i].options.priceScaleId;return t[s]||(t[s]=this.$store.state[this.paneId].priceScales[s],t[s].indicators=[]),t[s].indicators.push(e[i].name),t},{}),this._originalActivePriceScales=JSON.parse(JSON.stringify(this.activePriceScales))}updatePriceScaleScaleMargins(e,t){t.syncable&&this.unsyncableMoveId!==t.id&&(this.syncMoveWithOthers(e,t.side,t.value)||(this.unsyncableMoveId=t.id)),this.activePriceScales[e].scaleMargins=t.value,this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:e,priceScale:this.activePriceScales[e]})}syncMoveWithOthers(e,t,i){const s=this.activePriceScales[e].scaleMargins;let r=!1;for(const a in this.activePriceScales){if(e===a)continue;const t=this.activePriceScales[a].scaleMargins;t.top===s.top&&t.bottom===s.bottom&&(F.set(this.activePriceScales[a],"scaleMargins",i),this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:a,priceScale:this.activePriceScales[a]}),r=!0)}return r}cancel(){for(const e in this._originalActivePriceScales)this.$store.commit(this.paneId+"/SET_PRICE_SCALE",{id:e,priceScale:this._originalActivePriceScales[e]});this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}close(){this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}bindEscKey(){this._handleEscKey||(this._handleEscKey=e=>{"Escape"===e.key&&this.close()},document.addEventListener("keydown",this._handleEscKey))}};Oe=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?we(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&Te(t,i,a),a})([N({components:{ChartPriceScale:Ce},name:"ChartLayout",props:{paneId:{required:!0},axis:{required:!0},layouting:{required:!0}}})],Oe);const Me=V(Oe,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"chart-layout",style:{left:e.axis.left+"px",right:e.axis.right+"px",bottom:e.axis.time+"px"},on:{dblclick:e.close}},[t("div",{staticClass:"chart-layout__controls"},[t("button",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"bottom",boundary:"window"},expression:"{ placement: 'bottom', boundary: 'window' }"}],staticClass:"btn -text",attrs:{title:"Revert back to original positions"},on:{click:e.cancel}},[t("i",{staticClass:"icon-eraser"})]),t("button",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"bottom",boundary:"window"},expression:"{ placement: 'bottom', boundary: 'window' }"}],staticClass:"btn -text",attrs:{title:"Save positions"},on:{click:e.close}},[t("i",{staticClass:"icon-check"})])]),e._l(e.activePriceScales,function(i,s){return t("chart-price-scale",{key:s,staticClass:"chart-layout__item",attrs:{paneId:e.paneId,priceScaleId:s,priceScale:i},on:{update:function(t){return e.updatePriceScaleScaleMargins(s,t)}}})})],2)},[],!1,null,null,null,null).exports;var xe=Object.defineProperty,Pe=Object.getOwnPropertyDescriptor;let Le=class extends F{constructor(){super(...arguments),t(this,"paneId"),t(this,"indicatorId")}get indicator(){return this.$store.state[this.paneId].indicators[this.indicatorId]}get showLegend(){return this.$store.state[this.paneId].showLegend}get name(){return this.indicator.displayName?this.indicator.displayName:this.indicator.name?this.indicator.name:this.indicatorId}get visible(){return!this.indicator.options||void 0===this.indicator.options.visible||this.indicator.options.visible}get error(){return this.$store.state[this.paneId].indicatorsErrors[this.indicatorId]}onClick(e){e.shiftKey?this.$emit("action",{actionName:"resize",indicatorId:this.indicatorId}):this.$emit("action",{indicatorId:this.indicatorId})}toggleVisibility(){this.$nextTick(()=>{this.$store.dispatch(this.paneId+"/toggleSerieVisibility",this.indicatorId)})}};Le=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?Pe(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&xe(t,i,a),a})([N({name:"IndicatorControl",props:{paneId:{required:!0},indicatorId:{required:!0}}})],Le);const Ae=V(Le,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"indicator",class:{"-error":!!e.error,"-disabled":!e.visible}},[t("button",{staticClass:"indicator__name pane-overlay",attrs:{type:"button"},on:{click:e.onClick}},[e._v(" "+e._s(e.name)+" ")]),t("div",{staticClass:"indicator__controls"},[t("button",{staticClass:"btn",attrs:{title:e.visible?"Hide":"Show"},on:{click:e.toggleVisibility}},[t("i",{class:{"icon-visible":!e.visible,"icon-hidden":e.visible}})]),t("button",{staticClass:"btn",attrs:{title:"Menu"},on:{click:function(t){return e.$emit("action",{indicatorId:e.indicatorId,actionName:"remove",event:t})}}},[t("i",{staticClass:"icon-cross"})]),t("button",{staticClass:"btn",attrs:{title:"Menu"},on:{click:function(t){return e.$emit("action",{indicatorId:e.indicatorId,actionName:"menu",event:t})}}},[t("i",{staticClass:"icon-more"})])]),t("div",{staticClass:"indicator__legend pane-overlay",attrs:{id:e.paneId+e.indicator.id}}),e.error?t("div",[t("i",{staticClass:"icon-warning ml4 mr8"}),e._v(" "+e._s(e.error)+" ")]):e._e()])},[],!1,null,"bdedeea6",null,null).exports;var De=Object.defineProperty,He=Object.getOwnPropertyDescriptor;let $e=class extends F{constructor(){super(...arguments),t(this,"paneId"),t(this,"value"),t(this,"dropdownTrigger",null),t(this,"indicatorId",null),t(this,"sorting"),t(this,"$refs")}get indicators(){return this.$store.state[this.paneId].indicators}get indicatorOrder(){return this.$store.state[this.paneId].indicatorOrder}get label(){const e=Object.values(this.indicators).length;return`${e} indicator${e>1?"s":""}`}toggleOverlay(){this.$emit("input",!this.value)}toggleDropdown(e,t){if(!e||this.dropdownTrigger&&this.indicatorId&&this.indicatorId===t)this.dropdownTrigger=null,this.indicatorId=null;else{const i=e.currentTarget;this.indicatorId=t,this.dropdownTrigger=i}}async editIndicator(e){S.open((await f(()=>import("./IndicatorDialog.5c4cb14.js"),["IndicatorDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","Tab.5c4cb14.js","Tab.5c4cb14.css","IndicatorDropdown.5c4cb14.js","IndicatorDropdown.5c4cb14.css","options.5c4cb14.js","IndicatorDialog.5c4cb14.css"])).default,{paneId:this.paneId,indicatorId:e},"indicator"),this.dropdownTrigger=null}async addIndicator(){S.open((await f(()=>import("./IndicatorLibraryDialog.5c4cb14.js").then(e=>e.I),["IndicatorLibraryDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","marked.esm.5c4cb14.js","Tab.5c4cb14.js","Tab.5c4cb14.css","IndicatorLibraryDialog.5c4cb14.css"])).default,{},"indicator-library")}onClickIndicator({indicatorId:e,actionName:t,event:i}){if(!this.sorting||!this.sorting.moved){switch(t){case"menu":return this.toggleDropdown(i,e);case"remove":return this.$store.dispatch(this.paneId+"/removeIndicator",{id:e});case"resize":return this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING",e)}return this.editIndicator(e)}}bindSort(e,t){if(this.sorting)return;const i=Object.keys(this.indicators);let s=this.indicatorOrder.indexOf(e);-1===s&&(s=i.indexOf(e));const r=t.currentTarget,a=t.clientY;this.sorting={id:e,height:r.clientHeight,startY:a,maxPosition:i.length-1,oldPosition:s,newPosition:s},document.addEventListener("mousemove",this.handleSort),document.addEventListener("mouseup",this.unbindSort)}handleSort(e){if(!this.sorting)return;const t=e.clientY-this.sorting.startY;this.sorting.moved||(this.sorting.moved=Math.abs(t)>3);const i=Math.max(0,Math.min(this.sorting.maxPosition,this.sorting.oldPosition+Math.round(t/this.sorting.height)));i!==this.sorting.newPosition&&(this.sorting.newPosition=i,this.setIndicatorOrder(this.sorting.id,this.sorting.newPosition))}setIndicatorOrder(e,t){this.$store.commit(`${this.paneId}/UPDATE_INDICATOR_ORDER`,{id:e,position:t})}async unbindSort(){this.sorting&&(document.removeEventListener("mousemove",this.handleSort),document.removeEventListener("mouseup",this.unbindSort),await this.$nextTick(),setTimeout(()=>{this.sorting=null}))}};$e=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?He(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&De(t,i,a),a})([N({name:"IndicatorsOverlay",components:{IndicatorControl:Ae,IndicatorDropdown:de},props:{paneId:{type:String},value:{type:Boolean,required:!0}}})],$e);const Ge=V($e,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"chart-overlay__panel indicators-overlay"},[e.value?t("div",{staticClass:"chart-overlay__content"},[t("IndicatorDropdown",{attrs:{"indicator-id":e.indicatorId,"pane-id":e.paneId},model:{value:e.dropdownTrigger,callback:function(t){e.dropdownTrigger=t},expression:"dropdownTrigger"}}),e._l(e.indicatorOrder,function(i){return t("IndicatorControl",{key:i,attrs:{"indicator-id":i,"pane-id":e.paneId},on:{action:e.onClickIndicator},nativeOn:{mousedown:function(t){return e.bindSort(i,t)}}})})],2):e._e(),t("div",{staticClass:"chart-overlay__head pane-overlay",on:{click:e.toggleOverlay}},[t("span",{staticClass:"chart-overlay__title"},[e._v(" "+e._s(e.label)+" ")]),t("button",{staticClass:"btn badge -text",attrs:{type:"button"},on:{click:function(t){return t.stopPropagation(),e.addIndicator.apply(null,arguments)}}},[t("i",{staticClass:"icon-plus"})])])])},[],!1,null,null,null,null).exports;var ze=Object.defineProperty,Be=Object.getOwnPropertyDescriptor;let Ne=class extends F{constructor(){super(...arguments),t(this,"paneId"),t(this,"showOverlay",!1)}get markets(){return this.$store.state.panes.panes[this.paneId].markets}get hiddenMarkets(){return this.$store.state[this.paneId].hiddenMarkets}get visibleMarkets(){return this.markets.filter(e=>!this.hiddenMarkets[e]).length}get label(){const e=this.visibleMarkets;return`${e} market${e>1?"s":""}`}searchMarkets(e){this.$store.dispatch("app/showSearch",{paneId:this.paneId}),e.stopPropagation()}toggleMarket(e,t){this.$store.dispatch(this.paneId+"/toggleMarkets",{id:t,inverse:e.shiftKey})}toggleMarkets(e){this.$store.dispatch(this.paneId+"/toggleMarkets",{type:e})}};Ne=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?Be(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&ze(t,i,a),a})([N({name:"MarketsOverlay",props:{paneId:{type:String}}})],Ne);const je=V(Ne,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"chart-overlay__panel markets-overlay"},[e.showOverlay?t("div",{staticClass:"chart-overlay__content pane-overlay"},[t("div",{staticClass:"column"},[t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("perp")}}},[e._v("perp")]),t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("spot")}}},[e._v("spot")]),t("a",{staticClass:"btn -text",attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.toggleMarkets("all")}}},[e._v("all")])]),t("div",{staticClass:"mx4 mt0"},e._l(e.markets,function(i){return t("div",{key:i,on:{click:function(t){return e.toggleMarket(t,i)}}},[t("label",{staticClass:"checkbox-control -extra-small mb4"},[t("input",{staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:!e.hiddenMarkets[i]},on:{click:function(e){e.stopPropagation(),e.preventDefault()}}}),t("div"),t("span",[e._v(e._s(i))])])])}),0)]):e._e(),t("div",{staticClass:"chart-overlay__head pane-overlay",on:{click:function(t){e.showOverlay=!e.showOverlay}}},[t("div",{staticClass:"chart-overlay__title"},[e._v(" "+e._s(e.label)+" ")]),t("button",{staticClass:"btn badge -text",attrs:{type:"button"},on:{click:e.searchMarkets}},[t("i",{staticClass:"icon-plus"})])])])},[],!1,null,null,null,null).exports;var Fe=Object.defineProperty,qe=Object.getOwnPropertyDescriptor;let Ve=class extends(W(he)){constructor(){super(...arguments),t(this,"axis",{top:0,left:0,right:0,time:0}),t(this,"chart"),t(this,"$refs")}get layouting(){return this.refreshAxisSize(),this.$store.state[this.paneId].layouting}get overlayLeft(){return this.axis.left}get overlayTop(){return this.axis.top}get favoriteTimeframes(){return this.$store.state.settings.favoriteTimeframes}get timeframe(){return this.$store.state[this.paneId].timeframe}get isKnownTimeframe(){return-1!==Object.keys(this.favoriteTimeframes).indexOf(this.timeframe)}get showIndicators(){return this.$store.state[this.paneId].showIndicators}set showIndicators(e){this.$store.commit(`${this.paneId}/TOGGLE_INDICATORS`,e)}get timeframeForHuman(){return this.timeframe?x(this.timeframe):"ERR"}mounted(){this.chart=new _e(this.paneId,this.$refs.chartContainer),this.bindAggregator(),this.showIndicators&&this.$parent.$el.clientHeight>420&&(this.showIndicators=!0)}destroyChart(){this.unbindAggregator(),this.chart.destroy()}beforeDestroy(){this.destroyChart()}onTrades(e){this.chart.queueTrades(e)}onAlert(e){this.chart.onAlert(e)}bindAggregator(){T.on("trades",this.onTrades),T.on("alert",this.onAlert)}unbindAggregator(){T.off("trades",this.onTrades),T.off("alert",this.onAlert)}renderChart(){this.chart.renderAll()}onResize(){this.chart&&(this.chart.refreshChartDimensions(),this.chart.updateFontSize(),this.refreshAxisSize())}async refreshAxisSize(){this.$refs.chartContainer&&(await R(100),this.axis=this.chart.getAxisSize())}toggleLayout(){this.$store.commit(this.paneId+"/TOGGLE_LAYOUTING")}async toggleTimeframeDropdown(e,t){t.isLoading=!0,await this.chart.toggleTimeframeDropdown(e),t.isLoading=!1}restart(){this.chart.restart()}takeScreenshot(e){this.chart.takeScreenshot(e)}selectTimeframe(e,t){t!==this.timeframe?this.$store.dispatch(`${this.paneId}/setTimeframe`,t):this.toggleTimeframeDropdown(e,this.$refs.timeframeButton)}};Ve=((e,t,i,s)=>{for(var r,a=s>1?void 0:s?qe(t,i):t,n=e.length-1;n>=0;n--)(r=e[n])&&(a=(s?r(t,i,a):r(a))||a);return s&&a&&Fe(t,i,a),a})([N({name:"Chart",components:{ChartLayout:Me,PaneHeader:le,IndicatorsOverlay:Ge,MarketsOverlay:je,AlertsList:pe,Btn:K}})],Ve);const We=V(Ve,function(){var e=this,t=e._self._c;return e._self._setupProxy,t("div",{staticClass:"pane-chart"},[t("pane-header",{ref:"paneHeader",attrs:{paneId:e.paneId,settings:()=>f(()=>import("./ChartDialog.5c4cb14.js"),["ChartDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","paneDialogMixin.5c4cb14.js","ToggableGroup.5c4cb14.js","ToggableGroup.5c4cb14.css","AlertsSettings.5c4cb14.js"])},scopedSlots:e._u([{key:"menu",fn:function(){return[t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.toggleLayout}},[t("i",{staticClass:"icon-resize-height"}),t("span",[e._v("Arrange")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.restart}},[t("i",{staticClass:"icon-refresh"}),t("span",[e._v("Restart")])]),t("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:e.takeScreenshot}},[t("i",{staticClass:"icon-add-photo"}),t("span",[e._v("Snapshot")])])]},proxy:!0}])},[e._l(e.favoriteTimeframes,function(i,s){return t("button",{key:s,staticClass:"btn pane-chart__timeframe -text -cases",class:[e.timeframeForHuman===i&&"pane-header__highlight"],attrs:{title:"Maintain shift key to change timeframe on all panes"},on:{click:function(t){return e.selectTimeframe(t,s)}}},[t("span",[e._v(e._s(i))])])}),t("Btn",{ref:"timeframeButton",staticClass:"-arrow -cases pane-header__highlight pane-chart__timeframe-selector",on:{click:function(t){return e.toggleTimeframeDropdown(t,e.$refs.timeframeButton)}}},[t("span",[e._v(e._s(e.isKnownTimeframe?"":e.timeframeForHuman))])]),t("hr")],2),t("div",{staticClass:"chart-overlay hide-scrollbar",style:{left:e.overlayLeft+"px"}},[t("indicators-overlay",{attrs:{"pane-id":e.paneId},model:{value:e.showIndicators,callback:function(t){e.showIndicators=t},expression:"showIndicators"}}),t("markets-overlay",{attrs:{"pane-id":e.paneId}})],1),e.layouting?t("chart-layout",{attrs:{"pane-id":e.paneId,layouting:e.layouting,axis:e.axis}}):e._e(),t("div",{ref:"chartContainer",staticClass:"chart__container"})],1)},[],!1,null,"30b32c80",null,null).exports;export{We as default};
