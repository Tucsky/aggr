var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{w as s,F as i,K as a,C as o,V as n,a5 as r,a2 as h,n as d,ab as l,ah as u,U as c,m,l as p,q as f,ag as g,j as T,p as w,S as _,_ as L}from"./index.5c4cb14.js";import{P as I,a as A}from"./PaneHeader.5c4cb14.js";const v=new class{constructor(){e(this,"cache",{}),e(this,"promisesOfGifs",{}),setTimeout(this.cleanExpiredGifs.bind(this),6e4+6e4*Math.random())}async cleanExpiredGifs(){const t=await s.getGifsKeywords(),e=Date.now();for(const a of t){if(this.cache[a])continue;const t=i(a),o=await s.getGifs(t);(!o||e-o.timestamp>=6048e5)&&this.deleteGifs(a)}}forgetGifs(t){this.cache[t]&&(a.dispatch("app/showNotice",{title:"Forgeting "+this.cache[t].length+' gifs about "'+t+'"',type:"info"}),delete this.cache[t])}async deleteGifs(t){const e=i(t);await s.deleteGifs(e),a.dispatch("app/showNotice",{title:'Removed gifs about "'+t+'"',type:"info"})}async getGifs(t,e){if(!t)return;if(this.cache[t])return this.cache[t];if(this.promisesOfGifs[t])return this.promisesOfGifs[t];const a=i(t);return this.promisesOfGifs[t]=s.getGifs(a).then((s=>(delete this.promisesOfGifs[t],s&&Date.now()-s.timestamp<6048e5?(this.cache[t]=s.data,s.data):this.fetchGifByKeyword(t,e)))),this.promisesOfGifs[t]}async fetchGifByKeyword(t,e){if(!t)return;const o=i(t);return fetch("https://api.giphy.com/v1/gifs/search?q="+t+"&rating=r&limit=100&api_key=b5Y5CZcpj9spa0xEfskQxGGnhChYt3hi").then((t=>t.json())).then((async i=>{if(i.data&&i.data.length){this.cache[t]=[];for(const e of i.data)this.cache[t].push(e.images.downsized.url);return e&&a.dispatch("app/showNotice",{title:"Fetched "+this.cache[t].length+" "+t+" gifs",type:"success"}),await s.saveGifs({slug:o,keyword:t,timestamp:Date.now(),data:this.cache[t]}),this.cache[t]}})).finally((()=>{delete this.promisesOfGifs[t]}))}};var y=Object.defineProperty,b=Object.getOwnPropertyDescriptor;let E=class extends n{constructor(){super(...arguments),e(this,"paneId"),e(this,"showMore",!1)}get exchangesReady(){return this.$store.state.app.isExchangesReady}get paneMarkets(){return this.$store.state.panes.panes[this.paneId].markets}get paneMarketStringified(){return this.paneMarkets.join("\n")}get pairs(){const t=this.$store.state.settings.searchTypes.mergeUsdt;return this.paneMarkets.reduce(((e,s)=>{const i=this.$store.state.panes.marketsListeners[s];let a=i?i.local:s;return t&&(a=r(a)),-1===e.indexOf(a)&&e.push(a),e}),[])}get tradesThresholds(){return this.$store.state[this.paneId].thresholds}get liquidationsThresholds(){return this.$store.state[this.paneId].liquidations}get showTrades(){return this.$store.state[this.paneId].showTrades}get showLiquidations(){return this.$store.state[this.paneId].showLiquidations}get filterRecap(){const t=this.tradesThresholds[0].amount,e=this.liquidationsThresholds[0].amount;return this.showTrades&&this.showLiquidations?`Waiting for trades > ${h(t)} or liquidations > ${h(e)}`:this.showTrades?`Waiting for trades > ${h(t)}`:this.showLiquidations?`Waiting for liquidations > ${h(e)}`:"Nothing to show, see settings"}toggleShowMore(){this.showMore=!this.showMore;const t=document.activeElement;t&&t.blur()}};E=((t,e,s,i)=>{for(var a,o=i>1?void 0:i?b(e,s):e,n=t.length-1;n>=0;n--)(a=t[n])&&(o=(i?a(e,s,o):a(o))||o);return i&&o&&y(e,s,o),o})([o({name:"TradesPlaceholder",props:{paneId:{type:String,required:!0}}})],E);const x=d(E,(function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"trades-placeholder hide-scrollbar"},[e("p",{staticClass:"trades-placeholder__dimmed"},[t._v(t._s(t.filterRecap))]),t.exchangesReady?[t.showMore?e("pre",{domProps:{textContent:t._s(t.paneMarketStringified)}}):e("div",{staticClass:"pl16 pr16"},t._l(t.pairs,(function(s,i){return e("button",{key:i,staticClass:"btn mx4 -small",attrs:{disabled:""}},[t._v(" "+t._s(s)+" ")])})),0),t.paneMarkets.length?e("button",{staticClass:"mt8 btn -text trades-placeholder__dimmed -cases",on:{click:t.toggleShowMore}},[t._v(" "+t._s(t.showMore?"Show less":"Show more")+" ")]):t._e()]:e("p",[t._v("...")])],2)}),[],!1,null,null,null,null).exports;class M{constructor(t,s,i){e(this,"paneId"),e(this,"containerElement"),e(this,"count"),e(this,"maxCount"),e(this,"maxLevel"),e(this,"showGifs"),e(this,"showTrades"),e(this,"showLiquidations"),e(this,"showLogos"),e(this,"showPairs"),e(this,"showPrices"),e(this,"showAvgPrice"),e(this,"showTimeAgo"),e(this,"slippageMode"),e(this,"paneMarkets"),e(this,"tradesAudios"),e(this,"tradesColors"),e(this,"minimumTradeAmount"),e(this,"significantTradeAmount"),e(this,"maximumTradeAmount"),e(this,"liquidationsAudios"),e(this,"liquidationsColors"),e(this,"minimumLiquidationAmount"),e(this,"significantLiquidationAmount"),e(this,"maximumLiquidationAmount"),e(this,"audioThreshold"),e(this,"lastSide"),e(this,"lastTimestamp"),e(this,"timeUpdateInterval"),e(this,"marketsMultipliers"),this.paneId=t,this.containerElement=s,this.count=0,this.maxCount=i,this.cachePreferences(),this.cachePaneMarkets(),this.loadGifs(),this.prepareColors(),this.cacheAudio()}processTrades(t){let e="";for(let s=0;s<t.length;s++){const i=t[s].exchange+":"+t[s].pair;if(!this.paneMarkets[i])continue;const a=t[s];void 0!==this.marketsMultipliers[i]&&(a.amount/=this.marketsMultipliers[i]),!a.liquidation&&this.showTrades?a.amount>=this.minimumTradeAmount&&a.amount<this.maximumTradeAmount?e+=this.showTrade(a,i,this.tradesColors,this.tradesAudios,this.significantTradeAmount):a.amount>this.audioThreshold&&a.amount<this.maximumTradeAmount&&this.tradesAudios[0][a.side](l,a.amount/this.significantTradeAmount):a.liquidation&&this.showLiquidations&&(a.amount>=this.minimumLiquidationAmount&&a.amount<this.maximumLiquidationAmount?e+=this.showTrade(a,i,this.liquidationsColors,this.liquidationsAudios,this.significantLiquidationAmount):a.amount>this.audioThreshold&&a.amount<this.maximumLiquidationAmount&&this.liquidationsAudios[0][a.side](l,a.amount/this.significantLiquidationAmount))}return!!e.length&&(this.containerElement.insertAdjacentHTML("afterbegin",e),this.trim(),!0)}processTradesSilent(t){const e=this.audioThreshold,s=this.showGifs;this.audioThreshold=1/0,this.showGifs=!1,this.processTrades(t),this.audioThreshold=e,this.showGifs=s}getTradeInlineStyles(t,e,s){const i=(Math.max(t.amount,e.from)-e.from)/e.range,a=Math.min(1,t.amount/s),o=e[t.side];let n="";if(this.showGifs&&e[t.side].gif){const s=e[t.side].gif;v.cache[s]&&(n=`background-image:url('${v.cache[s][Math.floor(Math.random()*(v.cache[s].length-1))]}')`)}const r=o[(i<.5?"from":"to")+"Luminance"],h=u(o.from,o.to,i);let d;return d=r>(n?.15:.33)?"rgba(0, 0, 0, "+Math.min(1,.33+a)+")":"rgba(255, 255, 255, "+Math.min(1,.33+a)+")",`background-color:rgb(${h[0]}, ${h[1]}, ${h[2]});color:${d};${n}`}showTrade(t,e,s,i,a){let o=this.maxLevel,n=s[o];for(o=0;o<s.length;o++)if(t.amount<s[o].to){n=s[o];break}return o<s.length&&t.amount>this.audioThreshold&&i[o][t.side](l,t.amount/a),this.count++,this.renderRow(t,e,n,a)}renderRow(t,e,s,i){let a="",o="";if(t.timestamp!==this.lastTimestamp&&(a=" -timestamp",this.lastTimestamp=t.timestamp,!this.showTimeAgo)){const e=new Date(+t.timestamp),s=e.getMinutes();o=`${e.getHours()}:${s<10?"0":""}${s}`,a+=" -fixed"}let n="";this.slippageMode&&t.slippage&&(n=`<small>${t.slippage>0?"+":""}${t.slippage}${"bps"===this.slippageMode?" bps":""}</small>`);let r="";this.showLogos||(r=t.exchange.replace("_"," "));let d="";const l=t.side;(t.liquidation||l!==this.lastSide)&&(d=" icon-side",this.lastSide=l);let u="";return this.showPairs&&(u=`<div class="trade__pair">${t.pair.replace("_"," ")}</div>`),`<li class="trade -${t.exchange} -${t.side} -level-${s.level}${t.liquidation?" -liquidation":""}" title="${t.exchange}:${t.pair}" style="${this.getTradeInlineStyles(t,s,i)}">\n    <div class="trade__side${d}"></div>\n    <div class="trade__exchange">${r}</div>\n    ${u}\n    ${this.showPrices?`<div class="trade__price">${n}<span>${c(this.showAvgPrice?t.avgPrice:t.price,e)}</span></div>`:""}\n    <div class="trade__amount">\n    <span class="trade__amount__quote">\n         \n        <span class="icon-quote"></span>\n        <span>${h(t.size*t.avgPrice)}</span>\n         \n      </span>\n      <span class="trade__amount__base">\n        <span class="icon-base"></span>\n        <span>${Math.round(1e6*t.size)/1e6}</span>\n      </span>\n    </div>\n    <div class="trade__time ${a}" data-timestamp="${t.timestamp.toString()}">${o}</div>\n    </li>`}getTradesThesholds(){return a.state[this.paneId].thresholds}getLiquidationsThresholds(){return a.state[this.paneId].liquidations}async loadGifs(){this.loadThresholdsGifs(this.getTradesThesholds()),this.loadThresholdsGifs(this.getLiquidationsThresholds())}async loadThresholdsGifs(t){for(const e of t)e.buyGif&&v.getGifs(e.buyGif),e.sellGif&&v.getGifs(e.sellGif)}prepareColors(){const t=this.getTradesThesholds(),e=this.getLiquidationsThresholds(),s=m();this.tradesColors=this.prepareColorsThresholds(t,s),this.liquidationsColors=this.prepareColorsThresholds(e,s),this.maxLevel=t.length-1,this.minimumTradeAmount=t[0].amount,this.significantTradeAmount=t[1].amount,t[t.length-1].max?this.maximumTradeAmount=t[t.length-1].amount:this.maximumTradeAmount=1/0,this.minimumLiquidationAmount=e[0].amount,this.significantLiquidationAmount=e[1].amount,e[e.length-1].max?this.maximumLiquidationAmount=e[e.length-1].amount:this.maximumLiquidationAmount=1/0}prepareColorsThresholds(t,e){const s=[],i=t.length;for(let a=0;a<i;a++){if(a===i-1){s.push({...s[s.length-1],max:1/0});break}const o=p(t[a].buyColor,e),n=p(t[a+1].buyColor,e),r=p(t[a].sellColor,e),h=p(t[a+1].sellColor,e);s.push({from:t[a].amount,to:t[a+1].amount,range:t[a+1].amount-t[a].amount,level:Math.floor(a/(i-1)*4),max:a===i-1&&t[a+1].max,buy:{from:o,to:n,fromLuminance:f(o,e),toLuminance:f(n,e),gif:t[a].buyGif},sell:{from:r,to:h,fromLuminance:f(r,e),toLuminance:f(h,e),gif:t[a].sellGif}})}return s}async cacheAudio(t=!0){const e=a.state[this.paneId].audioThreshold;if(a.state.settings.useAudio&&!a.state[this.paneId].muted&&0!==a.state[this.paneId].audioVolume){if(e?"string"==typeof e&&/\d\s*%$/.test(e)?this.audioThreshold=this.minimumTradeAmount*(parseFloat(e)/100):this.audioThreshold=+e:this.audioThreshold=.1*this.minimumTradeAmount,!this.tradesAudios||t){const t=a.state[this.paneId].audioPitch;this.tradesAudios=await this.cacheAudioThresholds(this.getTradesThesholds(),t),this.liquidationsAudios=await this.cacheAudioThresholds(this.getLiquidationsThresholds(),t)}}else this.audioThreshold=1/0}async cacheAudioThresholds(t,e){const s=[];for(let i=0;i<t.length;i++)s.push({buy:await l.buildAudioFunction(t[i].buyAudio,"buy",e),sell:await l.buildAudioFunction(t[i].sellAudio,"sell",e)});return s}cachePreferences(){this.slippageMode=a.state.settings.calculateSlippage,this.showTrades=a.state[this.paneId].showTrades,this.showLiquidations=a.state[this.paneId].showLiquidations,this.showGifs=!a.state.settings.disableAnimations,this.showLogos=a.state[this.paneId].showLogos,this.showPairs=a.state[this.paneId].showPairs,this.showPrices=a.state[this.paneId].showPrices,this.showAvgPrice=a.state[this.paneId].showAvgPrice,this.showTimeAgo=a.state[this.paneId].showTimeAgo,this.showTimeAgo&&!this.timeUpdateInterval?this.setupTimeUpdateInterval():!this.showTimeAgo&&this.timeUpdateInterval&&(clearInterval(this.timeUpdateInterval),this.timeUpdateInterval=null)}cachePaneMarkets(){this.marketsMultipliers={},this.paneMarkets=a.state.panes.panes[this.paneId].markets.reduce(((t,e)=>{const[s]=e.split(":");if(!a.state.app.activeExchanges[s])return t[e]=!1,t;const i=a.state[this.paneId].multipliers[e];return void 0!==i&&(this.marketsMultipliers[e]=i),t[e]=!0,t}),{})}setupTimeUpdateInterval(){let t;const e=t=>t<6e4?Math.floor(t/1e3)+"s":t<36e5?Math.floor(t/6e4)+"m":Math.floor(t/36e5)+"h";this.timeUpdateInterval=setInterval((()=>{const s=this.containerElement.getElementsByClassName("-timestamp"),i=s.length;if(!i)return;t=Date.now();const a=t/1e3%60<1;let o;for(let n=0;n<i&&void 0!==s[n];n++){const i=t-s[n].getAttribute("data-timestamp"),r=e(i);if(r===o&&r)s[n-1].textContent="",s[n-1].className="trade__time";else{if(r!=s[n].textContent&&(s[n].textContent=r,!a&&"s"!==r[r.length-1]))break;o=r}}}),1e3)}setMaxCount(t){this.maxCount=t}trim(){for(;this.count>this.maxCount;)this.containerElement.removeChild(this.containerElement.lastChild),this.count--}clear(){this.containerElement.innerHTML="",this.count=0}destroy(){clearInterval(this.timeUpdateInterval)}}var S=Object.defineProperty,$=Object.getOwnPropertyDescriptor;let C=class extends(g(I)){constructor(){super(...arguments),e(this,"showPlaceholder",!0),e(this,"sliderDropdownTrigger",null),e(this,"feed"),e(this,"$refs")}get market(){return this.pane.markets[0]}get showLogos(){return this.$store.state[this.paneId].showLogos}get monochromeLogos(){return this.$store.state[this.paneId].monochromeLogos}get thresholdsMultipler(){return this.$store.state[this.paneId].thresholdsMultipler}get minAmount(){return this.$store.state[this.paneId].thresholds[0].amount}get gradient(){return[this.$store.state[this.paneId].thresholds[0].buyColor,this.$store.state[this.paneId].thresholds[this.$store.state[this.paneId].thresholds.length-1].buyColor]}formatAmount(t){return h(t)}created(){T.on("trades",this.onTrades),this._onStoreMutation=this.$store.subscribe((t=>{switch(t.type){case"app/EXCHANGE_UPDATED":case"settings/TOGGLE_SLIPPAGE":case this.paneId+"/TOGGLE_PREFERENCE":this.feed.cachePreferences(),this.refreshList();break;case this.paneId+"/SET_MAX_ROWS":this.feed.setMaxCount(t.payload);break;case"panes/SET_PANE_MARKETS":case this.paneId+"/SET_THRESHOLD_MULTIPLIER":"panes/SET_PANE_MARKETS"===t.type&&t.payload.id!==this.paneId||(this.feed.cachePaneMarkets(),this.refreshList());break;case this.paneId+"/SET_THRESHOLD_GIF":v.getGifs(t.payload.value,!0),this.feed.prepareColors(),this.refreshList();break;case this.paneId+"/SET_THRESHOLD_AUDIO":case this.paneId+"/SET_AUDIO_VOLUME":case this.paneId+"/SET_AUDIO_PITCH":case"settings/SET_AUDIO_VOLUME":case"settings/TOGGLE_AUDIO":this.feed.cacheAudio();break;case this.paneId+"/SET_AUDIO_THRESHOLD":case this.paneId+"/TOGGLE_MUTED":this.feed.cacheAudio(!1);break;case"settings/SET_BACKGROUND_COLOR":case this.paneId+"/SET_THRESHOLD_COLOR":case this.paneId+"/SET_THRESHOLD_AMOUNT":case this.paneId+"/SET_THRESHOLDS_MULTIPLER":case this.paneId+"/TOGGLE_THRESHOLD_MAX":case this.paneId+"/DELETE_THRESHOLD":case this.paneId+"/ADD_THRESHOLD":this.feed.prepareColors(),this.refreshList(),(t.type===this.paneId+"/DELETE_THRESHOLD"||(this.paneId,1))&&this.feed.cacheAudio()}}))}mounted(){this.feed=new M(this.paneId,this.$refs.tradesContainer,this.$store.state[this.paneId].maxRows)}beforeDestroy(){T.off("trades",this.onTrades),this.feed&&this.feed.destroy()}onTrades(t){this.feed.processTrades(t)===this.showPlaceholder&&(this.showPlaceholder=!1)}refreshList(){var t;const e=this.$el.getElementsByClassName("trade"),s=[];for(const i of e){const[e,a]=w(i.getAttribute("title")),o=i.querySelector(".trade__time").getAttribute("data-timestamp"),n=parseFloat(null==(t=i.querySelector(".trade__price"))?void 0:t.innerText)||0,r=parseFloat(i.querySelector(".trade__amount__base").innerText)||0,h=i.classList.contains("-buy")?"buy":"sell",d={timestamp:o,exchange:e,pair:a,price:n,avgPrice:n,amount:r*(this.$store.state.settings.preferQuoteCurrencySize?n:1),size:r,side:h};i.classList.contains("-liquidation")&&(d.liquidation=!0),s.push(d)}this.feed.clear(),this.feed.processTradesSilent(s)}upgradeToLite(){this.$store.dispatch(`${this.paneId}/upgradeToLite`)}};C=((t,e,s,i)=>{for(var a,o=i>1?void 0:i?$(e,s):e,n=t.length-1;n>=0;n--)(a=t[n])&&(o=(i?a(e,s,o):a(o))||o);return i&&o&&S(e,s,o),o})([o({components:{PaneHeader:A,TradesPlaceholder:x,Slider:_},name:"Trades"})],C);const G=d(C,(function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"pane-trades"},[e("pane-header",{ref:"paneHeader",attrs:{paneId:t.paneId,settings:()=>L((()=>import("./TradesDialog.5c4cb14.js")),["TradesDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","paneDialogMixin.5c4cb14.js","ToggableGroup.5c4cb14.js","ToggableGroup.5c4cb14.css","TradesDialog.5c4cb14.css"])},scopedSlots:t._u([{key:"menu",fn:function(){return[e("button",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"left",boundary:"window",followCursor:!0,distance:32},expression:"{\n          placement: 'left',\n          boundary: 'window',\n          followCursor: true,\n          distance: 32\n        }"}],staticClass:"dropdown-item",attrs:{type:"button",title:"✨ Upgrade to the canvas based feed for better performance ✨"},on:{click:t.upgradeToLite}},[t._v(" 🚀 "),e("span",{staticClass:"ml8"},[t._v("Upgrade")])])]},proxy:!0}])},[e("hr"),e("dropdown",{attrs:{interactive:"","no-scroll":""},model:{value:t.sliderDropdownTrigger,callback:function(e){t.sliderDropdownTrigger=e},expression:"sliderDropdownTrigger"}},[e("slider",{staticStyle:{width:"100px"},attrs:{min:0,max:10,step:.01,label:"","show-completion":!1,gradient:t.gradient,value:t.thresholdsMultipler,log:""},on:{input:function(e){return t.$store.commit(t.paneId+"/SET_THRESHOLDS_MULTIPLER",{value:e,market:t.market})},reset:function(e){return t.$store.commit(t.paneId+"/SET_THRESHOLDS_MULTIPLER",{value:1,market:t.market})}},scopedSlots:t._u([{key:"tooltip",fn:function(){return[t._v(" "+t._s(t.formatAmount(t.thresholdsMultipler*t.minAmount))+" ")]},proxy:!0}])})],1),e("button",{staticClass:"btn",on:{click:function(e){t.sliderDropdownTrigger=t.sliderDropdownTrigger?null:e.currentTarget}}},[e("i",{staticClass:"icon-gauge"})])],1),e("ul",{ref:"tradesContainer",staticClass:"trades-list",class:["hide-scrollbar",this.showLogos&&"-logos",!this.monochromeLogos&&"-logos-colors"]}),t.showPlaceholder?e("trades-placeholder",{attrs:{paneId:t.paneId}}):t._e()],1)}),[],!1,null,null,null,null).exports;export{G as default};
