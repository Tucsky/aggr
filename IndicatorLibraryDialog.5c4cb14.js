var t=Object.defineProperty,e=(e,i,a)=>(((e,i,a)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[i]=a})(e,"symbol"!=typeof i?i+"":i,a),a);import{n as i,C as a,V as s,x as n,u as r,y as o,w as l,d as c,z as d,A as h,B as p,k as m,L as u,_ as g,D as v,E as w,F as b,G as f,H as _,h as y,a as I}from"./index.5c4cb14.js";import{m as C}from"./marked.esm.5c4cb14.js";import{T as P,a as x}from"./Tab.5c4cb14.js";const k=i({props:{value:{type:String,default:""}}},function(){var t=this,e=t._self._c;return e("div",{staticClass:"search-bar form-control"},[e("input",{directives:[{name:"autofocus",rawName:"v-autofocus"}],staticClass:"search-bar__input form-control w-100",attrs:{type:"text",placeholder:"Search"},domProps:{value:t.value},on:{input:function(e){return t.$emit("input",e.currentTarget.value)}}}),t._t("default")],2)},[],!1,null,"da6a250e",null,null).exports;var D=Object.defineProperty,E=Object.getOwnPropertyDescriptor;const T=300,$=100;let j=class extends s{constructor(){super(...arguments),e(this,"previewCanvasElement"),e(this,"previewImageElement"),e(this,"previewObjectUrl"),e(this,"currentPreviewId"),e(this,"previewCtx")}mounted(){this.mountPreview()}beforeDestroy(){document.getElementById("app").removeChild(this.previewCanvasElement)}mountPreview(){const t=window.devicePixelRatio||1;this.previewCanvasElement=document.createElement("canvas"),this.previewCanvasElement.width=T*t,this.previewCanvasElement.height=$*t,this.previewCanvasElement.style.width=`${T}px`,this.previewCanvasElement.style.height=`${$}px`,this.previewCanvasElement.style.top="-1rem",this.previewCanvasElement.style.left="0",this.previewCanvasElement.style.position="absolute",this.previewCanvasElement.style.pointerEvents="none",this.previewCanvasElement.style.zIndex="11",this.previewCanvasElement.style.borderRadius="0.75rem",document.getElementById("app").appendChild(this.previewCanvasElement),this.previewCtx=this.previewCanvasElement.getContext("2d")}async showPreview(t){n()||(t.preview||(t.imagePath&&(t.preview=await fetch(`https://lib.aggr.trade/${t.imagePath}`).then(e=>{if(!e.ok)throw t.imagePath=null,new Error("Network response was not ok");return e.blob()})),t.preview)?t.id!==this.currentPreviewId&&(this.clearPreview(),this.currentPreviewId=t.id,t.preview instanceof Blob&&(this.previewObjectUrl=URL.createObjectURL(t.preview),this.previewImageElement=new Image,this.previewImageElement.src=this.previewObjectUrl,this.previewImageElement.addEventListener("load",this.onLoad))):this.clearPreview())}onLoad(){const{width:t,height:e}=this.previewImageElement,i=window.devicePixelRatio||1;this.previewCtx.drawImage(this.previewImageElement,t-T*i,0,T*i,e,0,0,T*i,$*i),URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null,this.previewImageElement=null}movePreview(t){if(!this.previewCanvasElement)return;const e=r(t);this.previewCanvasElement.style.transform=`translate(${e.x-T/2}px, ${e.y-$}px)`}clearPreview(){this.previewCtx.clearRect(0,0,this.previewCanvasElement.width,this.previewCanvasElement.height),this.currentPreviewId=null,this.previewImageElement&&(this.previewImageElement.removeEventListener("load",this.onLoad),this.previewImageElement.src="",this.previewImageElement=null),this.previewObjectUrl&&(URL.revokeObjectURL(this.previewObjectUrl),this.previewObjectUrl=null)}};j=((t,e,i,a)=>{for(var s,n=a>1?void 0:a?E(e,i):e,r=t.length-1;r>=0;r--)(s=t[r])&&(n=(a?s(e,i,n):s(n))||n);return a&&n&&D(e,i,n),n})([a],j);const O=i({name:"IndicatorTable",mixins:[j],props:{indicators:{type:Array,required:!0},query:{type:String,default:""},showDropdown:{type:Boolean,default:!1},showAuthor:{type:Boolean,default:!1},showEnabled:{type:Boolean,default:!1}},data:()=>({ago:o,sortDirection:-1,sortProperty:"updatedAt"}),computed:{queryFilter(){return new RegExp(this.query.replace(/\W/,".*"),"i")},sortFunction(){return"description"===this.sortProperty?this.sortDirection>0?(t,e)=>(t.description||"").localeCompare(e.description||""):(t,e)=>(e.description||"").localeCompare(t.description||""):"name"===this.sortProperty?this.sortDirection>0?(t,e)=>(t.name||"").localeCompare(e.name||""):(t,e)=>(e.name||"").localeCompare(t.name||""):"createdAt"===this.sortProperty?this.sortDirection>0?(t,e)=>t.createdAt-e.createdAt:(t,e)=>e.createdAt-t.createdAt:"updatedAt"===this.sortProperty?this.sortDirection>0?(t,e)=>t.updatedAt-e.updatedAt:(t,e)=>e.updatedAt-t.updatedAt:"author"===this.sortProperty?this.sortDirection>0?(t,e)=>t.author-e.author:(t,e)=>e.author-t.author:(t,e)=>t.id.localeCompare(e.id)},filteredIndicators(){const t=this.sortFunction;return this.indicators.filter(t=>this.queryFilter.test(t.description)||this.queryFilter.test(t.name)).sort(t)}},methods:{toggleSort(t){t===this.sortProperty&&(this.sortDirection=-1*this.sortDirection),this.sortProperty=t}}},function(){var t=this,e=t._self._c;return e("table",{staticClass:"table indicator-table__table"},[e("thead",[e("tr",[t.showEnabled?e("th",{staticClass:"table-min"}):t._e(),e("th",{staticClass:"table-sortable table-min",class:["name"===t.sortProperty&&"table-sort--active"],on:{click:function(e){return t.toggleSort("name")}}},[e("span",[t._v("Name")]),"name"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),e("th",{staticClass:"table-sortable w-100",on:{click:function(e){return t.toggleSort("description")}}},[e("span",[t._v("Description")]),"description"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showAuthor?e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(e){return t.toggleSort("author")}}},[e("span",[t._v("Author")]),"author"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]):t._e(),e("th",{staticClass:"-dialog-min-m table-sortable text-right",on:{click:function(e){return t.toggleSort("updatedAt")}}},[e("span",[t._v("Date")]),"updatedAt"===t.sortProperty?e("i",{staticClass:"table-sortable__direction icon-up",class:[t.sortDirection<0&&"table-sortable__direction--desc"]}):t._e()]),t.showDropdown?e("th",{staticClass:"table-min"}):t._e()])]),t.filteredIndicators.length?e("tbody",{on:{mousemove:t.movePreview,mouseleave:t.clearPreview}},t._l(t.filteredIndicators,function(i){return e("tr",{key:i.id,staticClass:"-action",on:{click:function(e){return t.$emit("selected",i)},mouseenter:function(e){return t.showPreview(i)}}},[t.showEnabled?e("td",{staticClass:"table-action table-min",on:{click:function(e){return e.stopPropagation(),t.$emit("enabled",i)}}},[e("i",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"top"},expression:"{ placement: 'top' }"}],staticClass:"-lower",class:i.enabled?"icon-star-filled":"icon-star",attrs:{title:"Enable by default<br>on new charts"}})]):t._e(),e("td",{staticClass:"table-input text-color-base table-ellipsis",staticStyle:{"max-width":"200px"}},[t._v(" "+t._s((i.displayName||i.name).replace(/\{[\w_]+\}/g,""))+" ")]),e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(i.description))])]),t.showAuthor?e("td",{staticClass:"table-input table-ellipsis"},[e("span",{staticClass:"text-muted"},[t._v(t._s(i.author))])]):t._e(),e("td",{staticClass:"-dialog-min-m table-input table-min text-right"},[e("span",[t._v(t._s(t.ago(i.updatedAt)))])]),t.showDropdown?e("td",{staticClass:"table-action -hover table-min",on:{click:function(e){return e.stopPropagation(),t.$emit("dropdown",[e,i])}}},[t._m(0,!0)]):t._e()])}),0):t._e()])},[function(){var t=this._self._c;return t("button",{staticClass:"btn -text -small"},[t("i",{staticClass:"icon-more"})])}],!1,null,"a17c4c26",null,null).exports;const U=i({name:"InstalledIndicators",components:{IndicatorTable:O,SearchBar:k},data:()=>({indicators:[],query:"",selectedIndicator:null,dropdownTrigger:null}),async created(){await this.getIndicators()},methods:{async getIndicators(){const t=+new Date("2021-06-07T00:00:00Z");await this.$nextTick(),this.indicators=(await l.getIndicators()).map(e=>({...e,enabled:void 0!==e.enabled&&e.enabled,updatedAt:e.updatedAt||t}))},async removeIndicator(t=this.selectedIndicator){await c.confirm({message:`Delete indicator "${t.name}" ?<br><br><code class="-filled"><small>#${t.id}</small></code>`,html:!0})&&(l.deleteIndicator(t.id),this.indicators.splice(this.indicators.indexOf(t),1))},async selectIndicator(t=this.selectedIndicator){this.$emit("add",t)},async duplicateIndicator(t=this.selectedIndicator){d.importIndicator({type:"indicator",name:t.name,data:t},{addToChart:!0})},async downloadIndicator(t=this.selectedIndicator){await h({type:"indicator",name:t.name,data:t},"indicator_"+t.id)},toggleDropdown([t,e]){!t||this.dropdownTrigger&&this.selectedIndicator===e?(this.dropdownTrigger=null,this.selectedIndicator=null):(this.dropdownTrigger=t.currentTarget,this.selectedIndicator=e)},toggleEnabled(t){t.enabled=!t.enabled,l.saveIndicator(t,!0)}}},function(){var t=this,e=t._self._c;return e("div",{staticClass:"installed-indicators"},[e("SearchBar",{model:{value:t.query,callback:function(e){t.query=e},expression:"query"}}),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-enabled":"","show-dropdown":""},on:{selected:function(e){return t.$emit("selected",e)},enabled:t.toggleEnabled,dropdown:t.toggleDropdown}}),e("dropdown",{model:{value:t.dropdownTrigger,callback:function(e){t.dropdownTrigger=e},expression:"dropdownTrigger"}},[e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.selectIndicator()}}},[e("i",{staticClass:"icon-plus"}),e("span",[t._v("Add to chart")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.duplicateIndicator()}}},[e("i",{staticClass:"icon-copy-paste"}),e("span",[t._v("Duplicate")])]),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.downloadIndicator()}}},[e("i",{staticClass:"icon-download"}),e("span",[t._v("Download")])]),e("div",{staticClass:"dropdown-divider"}),e("button",{staticClass:"dropdown-item",attrs:{type:"button"},on:{click:function(e){return t.removeIndicator()}}},[e("i",{staticClass:"icon-trash"}),e("span",[t._v("Remove")])])])],1)},[],!1,null,"f04bb70c",null,null).exports;const L=i({name:"CommunityIndicatorsIncentive",components:{Btn:p},data:()=>({isDismissed:m.hasDismissed("community-indicators-incentive"),repoUrl:"https://github.com/Tucsky/aggr-lib"}),methods:{dismiss(){m.dismiss("community-indicators-incentive"),this.isDismissed=!0}}},function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators-incentive",class:[t.isDismissed&&"community-indicators-incentive--dismissed"]},[e("div",{staticClass:"community-indicators-incentive__wrapper"},[e("div",{staticClass:"community-indicators-incentive__head"},[e("h3",{staticClass:"community-indicators-incentive__title"},[t._v(" Introducing Aggr Library ")]),t.isDismissed?t._e():e("Btn",{staticClass:"community-indicators-incentive__close -small -text",on:{click:t.dismiss}},[e("i",{staticClass:"icon-cross"})])],1),e("p",{staticClass:"community-indicators-incentive__subtitle"},[t._v(" Indicators that are uploaded to "),e("a",{attrs:{href:t.repoUrl,target:"_blank"}},[t._v("aggr-lib")]),t._v(" will automatically appear in this list. ")]),e("Btn",{staticClass:"community-indicators-incentive__cta -theme",attrs:{href:t.repoUrl,target:"_blank"}},[e("i",{staticClass:"icon-github mr8"}),t._v(" Start contributing ")])],1)])},[],!1,null,"cebd7c4e",null,null).exports;let A=[];const B=i({name:"CommunityIndicators",components:{SearchBar:k,IndicatorTable:O,LibraryIncentive:L,Loader:u,Btn:p},data:()=>({indicators:A,query:"",selectedIndicator:null,dropdownTrigger:null,isLoading:!1}),async created(){A.length||await this.getIndicators()},methods:{async getIndicators(){this.isLoading=!0;try{A=await(await fetch("https://lib.aggr.trade/library/indicators")).json(),this.indicators=A}catch(t){this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicators"})}finally{this.isLoading=!1}}}},function(){var t=this,e=t._self._c;return e("div",{staticClass:"community-indicators"},[t.isLoading?e("Loader",{staticClass:"community-indicators__loader"}):t._e(),e("transition",{attrs:{name:"transition-height-scale"}},[t.isLoading?t._e():e("div",{staticClass:"community-indicators__wrapper"},[e("LibraryIncentive"),e("SearchBar",{staticClass:"community-indicators__search-bar",model:{value:t.query,callback:function(e){t.query=e},expression:"query"}},[e("Btn",{staticClass:"-text -small",on:{click:t.getIndicators}},[e("i",{staticClass:"icon-refresh"})])],1),e("IndicatorTable",{staticClass:"table--inset",attrs:{indicators:t.indicators,query:t.query,"show-author":""},on:{selected:function(e){return t.$emit("selected",e)}}})],1)])],1)},[],!1,null,"26d8a1e7",null,null).exports;const S=i({name:"EditResourceDialog",components:{Btn:p,MarkdownEditor:()=>g(()=>import("./MarkdownEditor.5c4cb14.js"),["MarkdownEditor.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","marked.esm.5c4cb14.js","MarkdownEditor.5c4cb14.css"])},props:{item:{type:Object,required:!0},ids:{type:Array,required:!0}},mixins:[v],data(){return{dialogOpened:!1,name:this.item.name||"",description:this.item.description||"",updateId:!1,imageObjectUrl:null,newImagePreview:null,hasDeletedPreview:!1}},computed:{displayId(){const t=this.item.id;return t?t.length<=16?t:t.slice(0,6)+".."+t.substr(-6):"no id"},newId(){return w(b(this.name),this.idsExceptCurrent)},idsExceptCurrent(){return this.ids.filter(t=>t!==this.item.id)},hasCustomPreview(){return!this.hasDeletedPreview&&!!(this.newImagePreview||this.item.preview instanceof File)},previewName(){return this.hasCustomPreview?this.item.id+".png":"Browse"}},mounted(){this.loadPreview(),this.show()},beforeDestroy(){this.clearPreview()},methods:{show(){this.dialogOpened=!0},hide(){this.dialogOpened=!1},onHide(){this.close()},submit(){this.output={...this.item,name:this.name,displayName:this.name,description:this.description},this.newImagePreview?this.output.preview=this.newImagePreview:this.hasDeletedPreview&&(this.output.preview=null),this.updateId&&(this.output.id=this.newId),this.hide()},loadPreview(){this.clearPreview();const t=this.newImagePreview||this.item.preview;(t instanceof File||t instanceof Blob)&&(this.imageObjectUrl=URL.createObjectURL(t))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},handlePreviewFile(){const t=event.target.files[0];t&&(this.newImagePreview=t,this.hasDeletedPreview=!1,this.loadPreview())},removePreview(){this.newImagePreview&&(this.newImagePreview=null),this.clearPreview(),this.hasDeletedPreview=!0},resizeEditor(){this.$refs.editor&&this.$refs.editor.resize()}}},function(){var t=this,e=t._self._c;return e("form",{on:{submit:function(e){return e.preventDefault(),t.submit.apply(null,arguments)}}},[e("transition",{attrs:{name:"dialog",duration:500},on:{"after-leave":t.onHide}},[t.dialogOpened?e("Dialog",{staticClass:"edit-resource-dialog",on:{clickOutside:t.hide,resize:t.resizeEditor},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title"},[t._v("Edit "+t._s(t.item.name))]),e("small",{staticClass:"-center"},[e("code",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"-filled -center ml4",attrs:{title:`ID: ${t.item.id}`}},[t._v(" "+t._s(t.displayId)+" ")])])])]},proxy:!0},{key:"footer",fn:function(){return[e("Btn",{staticClass:"btn -text",attrs:{type:"button"},on:{click:t.hide}},[t._v("Cancel")]),e("Btn",{staticClass:"btn -green ml8 -large",attrs:{type:"submit"}},[e("i",{staticClass:"icon-check mr8"}),t._v(" Save ")])]},proxy:!0}],null,!1,2469990179)},[e("div",{staticClass:"d-flex -gap16 mb16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Name")]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.name,expression:"name"}],staticClass:"form-control w-100",attrs:{id:"label",type:"text",required:""},domProps:{value:t.name},on:{input:function(e){e.target.composing||(t.name=e.target.value)}}})]),t.item.name!==t.name?e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v(" ")]),e("label",{staticClass:"checkbox-control"},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.updateId,expression:"updateId"}],staticClass:"form-control",attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t.updateId)?t._i(t.updateId,null)>-1:t.updateId},on:{change:function(e){var i=t.updateId,a=e.target,s=!!a.checked;if(Array.isArray(i)){var n=t._i(i,null);a.checked?n<0&&(t.updateId=i.concat([null])):n>-1&&(t.updateId=i.slice(0,n).concat(i.slice(n+1)))}else t.updateId=s}}}),e("div",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"mr8",attrs:{title:"Get a new ID"}}),e("i",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info",attrs:{title:"IDs are unique in the library !"}})])]):t._e()]),t.updateId&&t.item.id!==t.newId?e("p",[e("i",{staticClass:"icon-info"}),t._v(" ID change "),e("code",{staticClass:"-filled"},[t._v(t._s(t.item.id))]),t._v(" → "),e("code",{staticClass:"-filled"},[t._v(t._s(t.newId))])]):t._e(),e("div",{staticClass:"form-group mb16 flex-grow-1 d-flex -column"},[e("label",{attrs:{for:"label"}},[t._v(" Description "),e("span",{directives:[{name:"tippy",rawName:"v-tippy"}],staticClass:"icon-info",attrs:{title:'Markdown supported <span class="badge -red ml4">new</span>'}})]),e("MarkdownEditor",{ref:"editor",staticClass:"w-100 flex-grow-1",staticStyle:{height:"auto"},attrs:{minimal:""},model:{value:t.description,callback:function(e){t.description=e},expression:"description"}})],1),e("div",{staticClass:"d-flex -gap16"},[e("div",{staticClass:"form-group"},[e("label",{attrs:{for:"label"}},[t._v("Preview")]),e("button",{staticClass:"btn -file -blue -cases"},[e("i",{staticClass:"icon-upload mr8"}),t._v(" "+t._s(t.previewName)+" "),t.hasCustomPreview?e("i",{staticClass:"icon-cross mr8 btn__suffix",on:{click:function(e){return e.stopPropagation(),e.preventDefault(),t.removePreview.apply(null,arguments)}}}):t._e(),e("input",{staticClass:"input-file",attrs:{type:"file",accept:"image/*"},on:{change:t.handlePreviewFile}})])]),e("div",{staticClass:"edit-resource-dialog__preview"},[t.imageObjectUrl?e("img",{attrs:{src:t.imageObjectUrl}}):t._e()])])]):t._e()],1)],1)},[],!1,null,"1831441d",null,null).exports;function N(t={}){const e=["priceScaleId","strokeWidth","scaleMargins","priceFormat","crosshairMarkerVisible","lastValueVisible","priceLineVisible","baseLineVisible","type","minMove","precision","priceLineStyle","color","lineWidth","lineStyle","lineType","priceLineColor","borderVisible","upColor","downColor","borderUpColor","borderDownColor","wickUpColor","wickDownColor","topFillColor1","topFillColor2","topLineColor","bottomFillColor1","bottomFillColor2","bottomLineColor","lineWidth","color","topColor","bottomColor","lineColor","lineStyle","lineWidth","positiveColor","negativeColor","positiveLineColor","higherLineStyle","higherLineWidth","negativeLineColor","lowerLineStyle","lowerLineWidth","color","thinBars","upColor","downColor","openVisible"];return Object.keys(t).filter(t=>e.includes(t)).reduce((e,i)=>(e[i]=t[i],e),{})}async function F(t){if(!t.preview)return void c.confirm({cancel:!1,message:"Indicator's preview is mandatory for publishing. Just save it once it's added on a chart to generate the thumbnail !"});let e=localStorage.getItem("author");if(!e){if(e=await c.prompt({action:"Name yourself",label:"Username"}),!e)return;localStorage.setItem("author",e)}const i={...t,options:N(t.options),preview:void 0,author:e},a=new FormData;try{const e=new Blob([JSON.stringify(i)],{type:"application/json"});a.append("jsonFile",e,"indicator.json"),a.append("pngFile",t.preview,"indicator.png")}catch(n){throw new Error("Failed to create payload")}const s=await fetch("https://lib.aggr.trade/publish/indicators",{method:"POST",body:a});if(!s.ok)throw new Error("Failed to publish");try{const{url:t}=await s.json();return t}catch(n){throw new Error("Failed to parse server response")}}const R=i({props:{id:{type:String,default:null},path:{default:null},preview:{default:null},isInstalled:{type:Boolean,default:!1}},components:{Btn:p},data:()=>({imageDimensions:{width:0,height:0},imagePosition:{x:0,y:0},isImageZoomed:!1,imageObjectUrl:null}),computed:{source(){return this.preview||this.path},image(){return this.imageObjectUrl?this.imageObjectUrl:this.path?`https://lib.aggr.trade/${this.path}`:null}},watch:{source:{immediate:!0,handler(){this.loadPreview()}}},beforeDestroy(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},methods:{loadPreview(){this.clearPreview();const t=this.preview;(t instanceof Blob||t instanceof File)&&(this.imageObjectUrl=URL.createObjectURL(t))},clearPreview(){this.imageObjectUrl&&(URL.revokeObjectURL(this.imageObjectUrl),this.imageObjectUrl=null)},onImageLoad(t){const e=t.target,i=window.devicePixelRatio||1;if(this.imageDimensions={height:e.naturalHeight/i,width:e.naturalWidth/i},this.imageDimensions.width<this.$el.clientWidth){const t=this.imageDimensions.height/this.imageDimensions.width;this.imageDimensions.width=this.$el.clientWidth,this.imageDimensions.height=this.$el.clientWidth*t}e.style.width=this.imageDimensions.width+"px",e.style.height=this.imageDimensions.height+"px",this.centerImage()},centerImage(){const t=this.$refs.preview,e=this.$refs.image;if(!e)return;const i=t.getBoundingClientRect(),a=e.getBoundingClientRect(),s=(i.width-a.width)/2,n=(i.height-a.height)/2;this.imagePosition.x=s,this.imagePosition.y=n,e.style.transform=`translate(${s}px, ${n}px)`},scheduleImageZoom(t){this.isImageZoomed||(this._imageZoomTimeout&&clearTimeout(this._imageZoomTimeout),this._imageZoomTimeout=setTimeout(async()=>{this._imageZoomTimeout=null,this.isImageZoomed=!0,await this.$nextTick(),this.moveImage(t)},1e3))},moveImage(t){const e=this.$refs.preview,i=this.$refs.image;if(!i)return;const a=e.getBoundingClientRect(),s=i.getBoundingClientRect();this.isImageZoomed&&(a.height=this.imageDimensions.height,s.height=this.imageDimensions.height);const n=Math.max(0,s.width-a.width),r=Math.max(0,s.height-a.height),o=t.clientX-a.left,l=t.clientY-a.top,c=o/a.width*n,d=l/a.height*r,h=Math.min(Math.max(-c,-n),0),p=Math.min(Math.max(-d,-r),0);this.imagePosition.x=h,this.imagePosition.y=p,i.style.transform=`translate(${h}px, ${p}px)`,this.scheduleImageZoom(t)},resetImage(){this.isImageZoomed=!1,this.centerImage(),this._imageZoomTimeout&&(clearTimeout(this._imageZoomTimeout),this._imageZoomTimeout=null)}}},function(){var t=this,e=t._self._c;return e("div",{ref:"preview",staticClass:"indicator-preview",class:[t.isImageZoomed&&"indicator-preview--zoomed"],style:{"--image-height":t.imageDimensions.height+"px"},on:{mousemove:t.moveImage,mouseleave:t.resetImage}},[t.id?[e("Btn",{staticClass:"indicator-preview__close -text",on:{click:function(e){return t.$emit("close")}}},[e("i",{staticClass:"icon-cross"})]),e("code",{staticClass:"indicator-preview__id -filled"},[e("small",[t._v("#"+t._s(t.id))])])]:t._e(),t.image?e("img",{ref:"image",attrs:{src:t.image},on:{load:t.onImageLoad}}):t._e()],2)},[],!1,null,"9a0f8a88",null,null).exports;const V=i({mixins:[v],components:{InstalledIndicators:U,CommunityIndicators:B,IndicatorDetail:i({props:{indicator:{type:Object,required:!0},paneId:{type:String,default:null}},components:{Btn:p,IndicatorPreview:R},data:()=>({opened:!1,isInstalling:!1,isPublishing:!1,isFetchingVersions:!1,menuDropdownTrigger:null,versionsDropdownTrigger:null,imageObjectUrl:null,fetchedVersions:null,dateIndex:0,communityTabEnabled:!0,footerColor:f("background-150",.5)}),computed:{isInstalled(){return!!this.indicator.script},createdAt(){return this.indicator.createdAt?`${o(this.indicator.createdAt)} ago`:null},updatedAt(){return this.indicator.updatedAt?`${o(this.indicator.updatedAt)} ago`:null},dates(){const t=[];return this.indicator.updatedAt&&t.push({title:"Updated at",label:"Updated",value:`${o(this.indicator.updatedAt)} ago`}),this.indicator.createdAt&&t.push({title:"Created at",label:"Created",value:`${o(this.indicator.createdAt)} ago`}),t},prId(){return this.indicator.pr?this.indicator.pr.split("/").pop():null},authorUrl(){return`https://github.com/Tucsky/aggr-lib/tree/main/indicators/${this.indicator.author}`},added(){return!(!this.paneId||!this.$store.state[this.paneId].indicators)&&!!Object.values(this.$store.state[this.paneId].indicators).find(t=>t.libraryId===this.indicator.id)},options(){return this.indicator.options?Object.keys(this.indicator.options).reduce((t,e)=>{const i=this.indicator.options[e];return i&&"object"!=typeof i?(t[e]=i,t):t},{}):{}},versions(){return this.indicator.versions||this.fetchedVersions||[]},description(){return this.indicator.description?C(this.indicator.description):this.installed?"Add description":""}},watch:{indicator:{immediate:!0,handler(){this.isInstalling&&this.addToChart()}}},mounted(){this.opened=!0},methods:{close(){this.opened=!1},toggleMenuDropdown(t){t&&!this.menuDropdownTrigger?this.menuDropdownTrigger=t.currentTarget:this.menuDropdownTrigger=null},async toggleVersionsDropdown(t){t&&!this.versionsDropdownTrigger?(this.indicator.versions||this.fetchedVersions||await this.fetchIndicatorVersions(),this.versionsDropdownTrigger=t.target):this.versionsDropdownTrigger=null},onBackdropClick(t){t.target===t.currentTarget&&this.close()},async fetchIndicatorVersions(){if(!this.indicator.versions){this.isFetchingVersions=!0,await _(1e3);try{this.fetchedVersions=await(await fetch(`https://lib.aggr.trade/versions/${this.indicator.jsonPath}`)).json()}catch{this.fetchedVersions=[]}finally{this.isFetchingVersions=!1}}},async installIndicator(t){if(!this.isInstalled){this.isInstalling=!0;try{const e=await async function(t,e,i){let a,s;if(i?(a=await(await fetch(`https://lib.aggr.trade/version/${i}/${t}`)).json(),s=await(await fetch(`https://lib.aggr.trade/version/${i}/${e}`)).blob()):(a=await(await fetch(`https://lib.aggr.trade/${t}`)).json(),s=await(await fetch(`https://lib.aggr.trade/${e}`)).blob()),!a.data)throw new Error("invalid payload");return a.data.preview=s,a}(this.indicator.jsonPath,this.indicator.imagePath,t);await d.importIndicator(e,!1,!0)}catch(e){this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to fetch indicator"})}finally{this.isInstalling=!1}}},addToChart(){this.$emit("add",this.indicator)},async editName(){if(!this.isInstalled)return;const t=await c.prompt({label:"Name",action:"Rename",placeholder:this.indicator.name});t&&t!==this.indicator.name&&(await l.saveIndicator({...this.indicator,name:t,displayName:t},!0),this.$emit("reload"))},async editDescription(){if(!this.isInstalled)return;const t=await c.prompt({label:"Description",action:"Edit",placeholder:this.indicator.description,input:this.indicator.description,markdown:!0},"edit-description");t&&t!==this.indicator.description&&(await l.saveIndicator({...this.indicator,description:t},!0),this.$emit("reload"))},async publish(){if(this.isInstalled)try{const t=await async function(t){if(m.hasDismissed("publish-onboarding")||await c.openAsPromise((await g(()=>import("./PublishOnboarding.5c4cb14.js"),["PublishOnboarding.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","PublishOnboarding.5c4cb14.css"])).default))return c.openAsPromise((await g(()=>import("./PublishResourceDialog.5c4cb14.js"),["PublishResourceDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","marked.esm.5c4cb14.js","Tab.5c4cb14.js","Tab.5c4cb14.css","PublishResourceDialog.5c4cb14.css"])).default,{item:t})}(this.indicator);t&&(await l.saveIndicator({...this.indicator,pr:t},!0),this.$emit("reload"))}catch(t){this.$store.dispatch("app/showNotice",{type:"error",title:"Failed to publish indicator"})}},async edit(){const t=await c.openAsPromise(S,{item:this.indicator,ids:await l.getIndicatorsIds()});t&&(t.id!==this.indicator.id&&await l.deleteIndicator(this.indicator.id),await l.saveIndicator(t,!0),this.$emit("reload",t.id))}}},function(){var t=this,e=t._self._c;return e("transition",{attrs:{name:"indicator-detail"},on:{"after-leave":function(e){return t.$emit("close")}}},[t.opened?e("div",{staticClass:"indicator-detail",on:{click:t.onBackdropClick}},[e("div",{staticClass:"indicator-detail__wrapper hide-scrollbar"},[e("IndicatorPreview",{staticClass:"indicator-detail__preview",attrs:{id:t.indicator.id,preview:t.indicator.preview,path:t.indicator.imagePath,"is-installed":t.isInstalled},on:{close:t.close}}),e("div",{staticClass:"indicator-detail__content"},[e("div",{staticClass:"indicator-detail__head"},[e("div",{staticClass:"indicator-detail__name"},[e("div",{on:{dblclick:t.editName}},[t._v(" "+t._s(t.indicator.displayName||t.indicator.name)+" ")]),t.isInstalled?e("Btn",{staticClass:"-text -small indicator-detail__toggle",on:{click:t.toggleMenuDropdown}},[e("i",{staticClass:"icon-more"})]):t._e()],1),e("small",{staticClass:"indicator-detail__subtitle"},[t.indicator.author?e("span",[t._v(" by "),e("a",{attrs:{href:t.authorUrl,target:"_blank"}},[t._v(t._s(t.indicator.author))])]):t._e(),e("span",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"top",distance:24},expression:"{ placement: 'top', distance: 24 }"}],attrs:{title:t.dates[t.dateIndex].title},on:{click:function(e){t.dateIndex=(t.dateIndex+1)%t.dates.length}}},[t._v(" "+t._s(t.dates[t.dateIndex].value)+" ")])])]),e("div",{staticClass:"indicator-detail__detail"},[e("div",{staticClass:"indicator-detail__inner"},[e("p",{staticClass:"indicator-detail__description",domProps:{innerHTML:t._s(t.description)},on:{dblclick:t.editDescription}}),e("div",{staticClass:"indicator-detail__options"},[t._l(t.options,function(i,a){return[i&&"priceScaleId"!==a&&"scaleMargins"!==a?e("div",{directives:[{name:"tippy",rawName:"v-tippy"}],key:`${a}`,staticClass:"badge -outline indicator-detail__option",attrs:{title:a}},[t._v(" "+t._s(i.toString().replace(" ",""))+" ")]):t._e()]})],2)]),e("ul",{staticClass:"indicator-detail__metadatas"},[t.indicator.pr?e("li",{directives:[{name:"tippy",rawName:"v-tippy",value:{placement:"right",distance:24},expression:"{ placement: 'right', distance: 24 }"}],attrs:{title:"Publish request"}},[e("span",[t._v("Publish")]),e("a",{staticClass:"indicator-detail__metadatas-value",attrs:{target:"_blank",href:t.indicator.pr}},[t._v(" #"+t._s(t.prId)+" ")])]):t._e()])])]),e("div",{staticClass:"indicator-detail__footer",style:{backgroundColor:t.footerColor}},[t.isInstalled?e("Btn",{on:{click:t.addToChart}},[e("i",{staticClass:"icon-plus mr4"}),t._v(" Add "+t._s(t.added?"again":"")+" ")]):e("div",{staticClass:"btn-group d-flex"},[e("Btn",{attrs:{loading:t.isInstalling,disabled:t.isInstalling||t.isFetchingVersions},on:{click:function(e){return t.installIndicator()}}},[t._v("Install")]),e("Btn",{class:[!t.isFetchingVersions&&"-arrow"],attrs:{loading:t.isFetchingVersions,disabled:t.isInstalling||t.isFetchingVersions},on:{click:t.toggleVersionsDropdown}})],1)],1),e("dropdown",{model:{value:t.menuDropdownTrigger,callback:function(e){t.menuDropdownTrigger=e},expression:"menuDropdownTrigger"}},[t.communityTabEnabled?e("btn",{staticClass:"dropdown-item -cases",attrs:{loading:t.isPublishing},on:{click:t.publish}},[e("i",{staticClass:"icon-external-link-square-alt"}),e("span",[t._v("Publish")])]):t._e(),e("Btn",{staticClass:"dropdown-item -cases",on:{click:t.edit}},[e("i",{staticClass:"icon-edit"}),e("span",[t._v("Edit")])])],1),e("dropdown",{model:{value:t.versionsDropdownTrigger,callback:function(e){t.versionsDropdownTrigger=e},expression:"versionsDropdownTrigger"}},[!t.versions.length&&t.fetchedVersions?[e("div",{staticClass:"px8 text-danger"},[t._v("No history available")])]:t._l(t.versions,function(i){return e("btn",{key:i.sha,staticClass:"dropdown-item -cases",attrs:{loading:t.isPublishing},on:{click:function(e){return t.installIndicator(i.sha)}}},[t._v(" "+t._s(i.date)+" ")])})],2)],1)]):t._e()])},[],!1,null,"37f2e69e",null,null).exports,TransitionHeight:y,Dialog:I,Tabs:P,Tab:x},data:()=>({name:"",tab:"installed",selection:null,communityTabEnabled:!0,ago:o}),computed:{isBack(){return"installed"===this.tab},paneId(){if(this.$store.state.app.focusedPaneId&&"chart"===this.$store.state.panes.panes[this.$store.state.app.focusedPaneId].type)return this.$store.state.app.focusedPaneId;for(const t in this.$store.state.panes.panes)if("chart"===this.$store.state.panes.panes[t].type)return t;return null}},methods:{async handleFile(t){try{const e=await d.getJSON(t.target.files[0]);await d.importIndicator(e,{save:!0,openLibrary:!0})}catch(e){this.$store.dispatch("app/showNotice",{title:e.message,type:"error"})}},showNoPaneId(){c.confirm({title:"No chart",message:"Add a chart to continue",cancel:null,ok:"Ok"})},async addToChart(t,e=!1){this.$store.dispatch(this.paneId+"/addIndicator",await l.incrementIndicatorUsage(t.id)),e&&this.close()},async createIndicator(t={}){if(!this.paneId)return this.showNoPaneId();t.name||(t.name="Untitled"),t.libraryId||(t.libraryId=null),c.openIndicator(this.paneId,await this.$store.dispatch(this.paneId+"/addIndicator",t)),this.close()},async promptCreateIndicator(){if(!this.paneId)return this.showNoPaneId();const t=await c.openAsPromise((await g(()=>import("./CreateIndicatorDialog.5c4cb14.js"),["CreateIndicatorDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","options.5c4cb14.js"])).default,{paneId:this.paneId});t&&this.createIndicator(t)},setSelection(t){this.selection=t,this.$refs.installed&&this.$refs.installed.getIndicators()},async reloadSelection(t){this.selection&&this.setSelection(await l.getIndicator(t||this.selection.id))}}},function(){var t=this,e=t._self._c;return e("Dialog",{staticClass:"indicator-library-dialog",attrs:{size:"medium",contrasted:""},on:{clickOutside:t.close},scopedSlots:t._u([{key:"header",fn:function(){return[e("div",{staticClass:"d-flex"},[e("div",{staticClass:"dialog__title indicator-dialog__title -center"},[e("div",[t._v("Indicators")])])])]},proxy:!0},{key:"subheader",fn:function(){return[e("tabs",{model:{value:t.tab,callback:function(e){t.tab=e},expression:"tab"}},[e("tab",{attrs:{name:"installed"}},[t._v(" Installed ")]),t.communityTabEnabled?e("tab",{attrs:{name:"community"}},[t._v(" Community ")]):t._e()],1)]},proxy:!0},{key:"footer",fn:function(){return[e("button",{staticClass:"btn -theme -large -cases -file"},[e("input",{ref:"importButton",staticClass:"input-file",attrs:{type:"file"},on:{change:t.handleFile}}),t._v(" Import "),e("i",{staticClass:"icon-upload ml8"})]),e("button",{staticClass:"mlauto btn -green -large -cases",on:{click:t.promptCreateIndicator}},[t._v(" Create "),e("i",{staticClass:"icon-plus ml8"})])]},proxy:!0}])},[e("TransitionHeight",{staticClass:"indicator-library-dialog__stepper",attrs:{stepper:"",name:"slide-fade-"+(t.isBack?"left":"right"),duration:500}},["installed"===t.tab?e("InstalledIndicators",{key:"installed",ref:"installed",attrs:{"pane-id":t.paneId},on:{close:t.close,add:t.addToChart,selected:function(e){t.selection=e}}}):"community"===t.tab?e("CommunityIndicators",{key:"community",attrs:{"pane-id":t.paneId},on:{close:t.close,selected:function(e){t.selection=e}}}):t._e()],1),t.selection?e("IndicatorDetail",{attrs:{indicator:t.selection,"pane-id":t.paneId},on:{close:function(e){t.selection=null},add:function(e){return t.addToChart(e,!0)},reload:t.reloadSelection}}):t._e()],1)},[],!1,null,"04757fb5",null,null).exports,q=Object.freeze(Object.defineProperty({__proto__:null,default:V},Symbol.toStringTag,{value:"Module"}));export{q as I,F as u};
