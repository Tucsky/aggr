var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);import{K as s,a7 as i,ai as a,l as h,ag as r,j as c,g as o,a2 as n,d as l,aj as u,C as d,n as p,_}from"./index.5c4cb14.js";import{d as m,j as k,k as b,v as f,Z as y,o as g}from"./options.5c4cb14.js";import{P as C,a as v}from"./PaneHeader.5c4cb14.js";class S{constructor(t,a,h){e(this,"id"),e(this,"name"),e(this,"window"),e(this,"precision"),e(this,"color"),e(this,"granularity"),e(this,"type"),e(this,"stacks",[]),e(this,"timestamp"),e(this,"live"),e(this,"filled",!1),e(this,"remaining",0),e(this,"adapter"),e(this,"serie"),e(this,"timeouts",[]),this.id=a.id,this.name=a.name,this.adapter=this.getAdapter(t),this.window=(isNaN(a.window)?s.state[h].window:+a.window)||6e4,this.precision=a.precision,this.color=this.parseColor(a.color),this.granularity=Math.max(s.state[h].granularity,this.window/5e3),this.type=a.type||"line";const r=i(this.window).replace(/^1(\w)$/,"$1");this.name+="/"+r,this.clear()}getAdapter(t){const e=t.replace(/([^.]|^)(vbuy|vsell|cbuy|csell|lbuy|lsell)/g,"$1stats.$2");return new Function("stats",`'use strict'; return ${e};`)}clear(){this.stacks=[],this.live=0,this.filled=!1,this.remaining=0;for(let t=0;t<this.timeouts.length;t++)clearTimeout(this.timeouts[t]);this.timeouts=[]}unbind(){this.clear()}onStats(t){const e=this.adapter(t);if(!this.stacks.length||t.timestamp>this.timestamp+this.granularity)this.appendStack(t.timestamp);else if(this.filled&&this.remaining){const e=(t.timestamp-this.timestamp)/this.granularity,s=Math.ceil(this.stacks[0]*(1-e)),i=this.remaining-s;this.remaining=s,this.live-=i}this.addData(e)}appendStack(t){t||(t=Date.now()),this.stacks.length&&!this.stacks[this.stacks.length-1]||(this.stacks.push(0),this.timeouts.push(setTimeout(this.shiftStack.bind(this),this.window))),this.timestamp=t,this.filled||this.stacks.length!==this.window/this.granularity||(this.filled=!0)}shiftStack(){this.timeouts.shift();this.stacks.shift()&&(this.remaining&&(this.live-=this.remaining),this.remaining=this.stacks[0])}addData(t){this.stacks[this.stacks.length-1]+=t,this.live+=t}getValue(){return this.live}createSerie(t){if(this.serie)return;const e="add"+(this.type.charAt(0).toUpperCase()+this.type.slice(1))+"Series",s=Object.assign({},m[this.type],{priceScaleId:this.name,title:this.name,priceLineVisible:!1,lineWidth:1,scaleMargins:{top:.05,bottom:.05},...this.getColorOptions()});this.serie=t[e](s)}updateSerie(){const t=this.getValue();if(!this.serie||!this.timestamp||"histogram"===this.type&&!t)return;const e={time:this.timestamp/1e3,value:t};"function"==typeof this.color&&(e.color=this.color(t)),this.serie.update(e)}getColorOptions(){if("function"==typeof this.color)return{};if("area"===this.type){let t,e,s;0===this.color.indexOf("#")?[t,e,s]=a(this.color):[t,e,s]=h(this.color);return{topColor:`rgba(${t},${e},${s}, .4)`,bottomColor:`rgba(${t},${e},${s}, 0)`,lineColor:this.color}}return{color:this.color}}parseColor(t){return/rgba?\(|#/.test(t)?t:new Function("value",'"use strict"; return '+t)}updateColor(t){this.serie&&(this.color=this.parseColor(t),"string"==typeof t&&this.serie.applyOptions(this.getColorOptions()))}removeIndicator(t){this.serie&&(t.removeSeries(this.serie),delete this.serie)}}var T=Object.defineProperty,I=Object.getOwnPropertyDescriptor;let E=class extends(r(C)){constructor(){super(...arguments),e(this,"data",{}),e(this,"$refs"),e(this,"_refreshChartDimensionsTimeout"),e(this,"_chart"),e(this,"_buckets",{}),e(this,"_feed",null)}get enableChart(){return this.$store.state[this.paneId].enableChart}get buckets(){return this.$store.state[this.paneId].buckets}created(){this._onStoreMutation=this.$store.subscribe((t=>{switch(t.type){case"settings/SET_TEXT_COLOR":this._chart&&t.payload&&this._chart.applyOptions(k(this.paneId));break;case"settings/SET_CHART_THEME":this._chart&&this._chart.applyOptions(k(this.paneId));break;case"panes/SET_PANE_MARKETS":case this.paneId+"/SET_WINDOW":if(t.payload.id&&t.payload.id!==this.paneId)break;this.prepareBuckets();break;case this.paneId+"/SET_BUCKET_COLOR":this.recolorBucket(t.payload.id,t.payload.value);break;case this.paneId+"/SET_BUCKET_TYPE":this._chart&&this.reloadBucketSerie(t.payload.id,t.payload.value);break;case this.paneId+"/TOGGLE_CHART":t.payload?this.createChart():this.removeChart();break;case this.paneId+"/TOGGLE_BUCKET":t.payload.value?this.createBucket(this.buckets[t.payload.id]):this.removeBucket(t.payload.id);break;case"panes/SET_PANE_ZOOM":t.payload.id===this.paneId&&this.updateFontSize();break;case this.paneId+"/REMOVE_BUCKET":this.removeBucket(t.payload);break;case this.paneId+"/SET_BUCKET_WINDOW":case this.paneId+"/SET_BUCKET_INPUT":case this.paneId+"/SET_BUCKET_PRECISION":this.refreshBucket(t.payload.id);break;case this.paneId+"/RENAME_BUCKET":this.refreshBucketName(t.payload)}})),this.prepareBuckets()}mounted(){this.enableChart&&this.createChart()}beforeDestroy(){this._feed&&c.off(this._feed,this.onVolume),this.clearBuckets(),this.removeChart(),this._chart=null}async createChart(){await this.$nextTick();const t=b(f,this.paneId);this._chart=y(this.$refs.chart,t);for(const e in this._buckets)this._buckets[e].createSerie(this._chart);this.refreshChartDimensions(0)}updateFontSize(){this._chart&&this._chart.applyOptions({layout:{fontSize:g(this.paneId)}})}removeChart(){if(this._chart){for(const t in this._buckets)this._buckets[t].removeIndicator(this._chart);this._chart.remove(),this._chart=null}}async refreshChartDimensions(t=500){this.enableChart&&(clearTimeout(this._refreshChartDimensionsTimeout),this._refreshChartDimensionsTimeout=setTimeout((()=>{this._chart&&this._chart.resize(this.$el.clientWidth,this.$el.clientHeight)}),t))}prepareBuckets(){this._feed&&c.off(this._feed,this.onVolume),this.clearBuckets();for(const t in this.buckets)this.createBucket(this.buckets[t]);this._feed="bucket-"+o(this.pane.markets),this._feed.length&&c.on(this._feed,this.onVolume)}onVolume(t){for(const e in this._buckets){if(this._buckets[e].onStats(t),this._buckets[e].stacks.length){const t=this._buckets[e].getValue();this.$set(this.data[e],"value",n(t,this._buckets[e].precision))}this._chart&&this._buckets[e].updateSerie()}}clearBuckets(){for(const t in this._buckets)this.removeBucket(t);this._buckets={}}removeBucket(t){this._buckets[t]&&(this._buckets[t].unbind(),this._chart&&this._buckets[t].removeIndicator(this._chart),this.$delete(this.data,t),delete this._buckets[t])}refreshBucket(t){const e=this.buckets[t];e&&(this.removeBucket(t),this.createBucket(e))}recolorBucket(t,e){this._buckets[t]&&(this._buckets[t].updateColor(e),this.$set(this.data[t],"color",e))}reloadBucketSerie(t,e){this._buckets[t]&&(e&&(this._buckets[t].type=e),this._buckets[t].removeIndicator(this._chart),this._buckets[t].createSerie(this._chart))}createBucket(t){if(t.enabled&&void 0===this.data[t.id]){const e=new S(t.input,t,this.paneId);this._chart&&e.createSerie(this._chart),this._buckets[t.id]=e,this.$set(this.data,e.id,{value:0,name:e.name,color:e.color})}}refreshBucketName({id:t,name:e}){this._buckets[t].name=e,this.$set(this.data[t],"name",e)}editStat(t){l.open(u,{paneId:this.paneId,bucketId:t})}onResize(){this.refreshChartDimensions()}};E=((t,e,s,i)=>{for(var a,h=i>1?void 0:i?I(e,s):e,r=t.length-1;r>=0;r--)(a=t[r])&&(h=(i?a(e,s,h):a(h))||h);return i&&h&&T(e,s,h),h})([d({components:{PaneHeader:v},name:"Stats"})],E);const B=p(E,(function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"pane-stats"},[e("pane-header",{attrs:{paneId:t.paneId,settings:()=>_((()=>import("./StatsDialog.5c4cb14.js")),["StatsDialog.5c4cb14.js","index.5c4cb14.js","index.5c4cb14.css","paneDialogMixin.5c4cb14.js"])}}),e("ul",{staticClass:"stats-buckets"},t._l(t.data,(function(s,i){return e("li",{key:i,staticClass:"stat-bucket",on:{click:function(e){return t.editStat(i)}}},[e("div",{staticClass:"stat-bucket__name"},[t._v(t._s(s.name))]),e("div",{staticClass:"stat-bucket__value"},[t._v(t._s(s.value))])])})),0),t.enableChart?e("div",{ref:"chart",staticClass:"stats-chart"}):t._e()],1)}),[],!1,null,null,null,null).exports;export{B as default};
